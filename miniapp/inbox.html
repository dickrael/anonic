<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Inbox â€” Incognitus</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="css/style.css?v=5">
  <style>
    /* ===== Stats Grid ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--tg-theme-secondary-bg-color);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      opacity: 0;
      transform: scale(0.8) translateY(12px);
      animation: statPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }

    @keyframes statPopIn {
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stat-icon {
      font-size: 28px;
      margin-bottom: 6px;
      display: block;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--tg-theme-text-color);
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
    }
    .stat-label {
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      font-weight: 500;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== Recent Section ===== */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--tg-theme-hint-color);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== Reply Area ===== */
    .reply-row { display:flex; gap:8px; margin-top:10px; }
    .reply-input {
      flex:1; padding:8px 12px;
      border:1.5px solid var(--tg-theme-secondary-bg-color);
      border-radius:10px; background:var(--tg-theme-bg-color);
      color:var(--tg-theme-text-color); font-size:14px;
      font-family:inherit; outline:none;
    }
    .reply-input:focus { border-color: var(--tg-theme-button-color); }
    .reply-btn {
      padding:8px 16px; border:none; border-radius:10px;
      background:var(--tg-theme-button-color);
      color:var(--tg-theme-button-text-color);
      font-size:14px; font-weight:600; cursor:pointer; white-space:nowrap;
    }
    .reply-btn:disabled { opacity:0.5; }
    .reply-status { font-size:12px; margin-top:4px; min-height:16px; }

    /* ===== Skeleton Stats ===== */
    .skeleton-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 24px;
    }
    .skeleton-stat {
      height: 90px;
      border-radius: 16px;
    }
    .skeleton-section-title {
      width: 120px;
      height: 16px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Loading skeleton -->
    <div id="loading" class="page-content">
      <div class="skeleton-stats">
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
      </div>
      <div class="skeleton skeleton-section-title"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display:none">
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <span class="stat-icon">ðŸ’¬</span>
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Messages</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸ””</span>
          <div class="stat-value" id="stat-unread">0</div>
          <div class="stat-label">Unread</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸ‘¤</span>
          <div class="stat-value" id="stat-senders">0</div>
          <div class="stat-label">Senders</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ðŸ“…</span>
          <div class="stat-value" id="stat-today">0</div>
          <div class="stat-label">Today</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title">Recent Messages</div>
        <div class="unread-badge" id="unread-badge" style="display:none">0</div>
      </div>
      <div class="message-list" id="message-list"></div>

      <div id="no-messages" style="display:none;text-align:center;padding:24px 0;">
        <div style="font-size:36px;margin-bottom:8px">ðŸ“­</div>
        <div style="font-size:14px;color:var(--tg-theme-hint-color)">No messages yet â€” share your link!</div>
      </div>
    </div>

    <!-- Auth error -->
    <div id="auth-error" style="display:none">
      <div class="empty-state">
        <div class="empty-icon">ðŸ”’</div>
        <div class="empty-title">Open in Telegram</div>
        <div class="empty-hint" id="auth-error-hint">This page must be opened from the Telegram app.</div>
        <pre id="debug-info" style="font-size:11px;color:var(--tg-theme-hint-color);margin-top:16px;text-align:left;word-break:break-all;white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>

  <script src="js/telegram.js?v=5"></script>
  <script src="js/api.js?v=5"></script>
  <script>
  (function() {
    "use strict";
    initWebApp();

    // ---- Auth ----
    function tryGetInitData() {
      var d = getInitData();
      if (d) return d;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData)
        return window.Telegram.WebApp.initData;
      return "";
    }

    function boot() {
      var data = tryGetInitData();
      if (data) { startApp(data); return; }
      setTimeout(function() {
        data = tryGetInitData();
        if (data) { startApp(data); return; }
        setTimeout(function() {
          data = tryGetInitData();
          if (data) { startApp(data); return; }
          document.getElementById("loading").style.display = "none";
          document.getElementById("auth-error").style.display = "block";
          showDebug();
        }, 1000);
      }, 500);
    }

    function showDebug() {
      var d = document.getElementById("debug-info");
      var tg = window.Telegram && window.Telegram.WebApp;
      var lines = ["TG: " + (tg ? "yes" : "no")];
      if (tg) {
        lines.push("platform: " + tg.platform);
        lines.push("initData len: " + (tg.initData || "").length);
        lines.push("user: " + JSON.stringify((tg.initDataUnsafe || {}).user || null));
      }
      lines.push("url: " + location.href.substring(0, 150));
      d.textContent = lines.join("\n");
    }

    // ---- Helpers ----
    function relativeTime(iso) {
      if (!iso) return "";
      var s = iso.replace(/\+00:00$/, "Z");
      if (s.indexOf("Z") < 0 && s.indexOf("+") < 0) s += "Z";
      var d = new Date(s);
      if (isNaN(d)) return iso;
      var sec = Math.floor((Date.now() - d.getTime()) / 1000);
      if (sec < 60) return "just now";
      if (sec < 3600) return Math.floor(sec / 60) + "m ago";
      if (sec < 86400) return Math.floor(sec / 3600) + "h ago";
      if (sec < 604800) return Math.floor(sec / 86400) + "d ago";
      return d.toLocaleDateString();
    }

    function esc(t) {
      var el = document.createElement("span");
      el.textContent = t;
      return el.innerHTML;
    }

    // Animated count-up
    function animateCounter(el, target, duration) {
      if (target === 0) { el.textContent = "0"; return; }
      var start = 0;
      var startTime = null;
      duration = duration || 800;

      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        var progress = Math.min((timestamp - startTime) / duration, 1);
        // Ease out cubic
        var eased = 1 - Math.pow(1 - progress, 3);
        var current = Math.round(start + (target - start) * eased);
        el.textContent = current;
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ---- App ----
    function startApp(initData) {
      var loadingEl   = document.getElementById("loading");
      var dashboardEl = document.getElementById("dashboard");
      var listEl      = document.getElementById("message-list");
      var badgeEl     = document.getElementById("unread-badge");
      var noMsgEl     = document.getElementById("no-messages");

      var statTotalEl   = document.getElementById("stat-total");
      var statUnreadEl  = document.getElementById("stat-unread");
      var statSendersEl = document.getElementById("stat-senders");
      var statTodayEl   = document.getElementById("stat-today");

      var knownIds = {};
      var expandedId = null;
      var allMessages = [];
      var pollTimer = null;
      var firstLoad = true;

      function renderCard(msg, animate, delay) {
        if (knownIds[msg.id]) return null;
        knownIds[msg.id] = true;
        allMessages.push(msg);

        var card = document.createElement("div");
        card.className = "message-card";
        card.setAttribute("data-id", msg.id);
        if (animate && delay !== undefined) card.style.animationDelay = delay + "ms";

        var html = '<div class="message-card-header">'
          + '<span class="sender-badge">' + esc(msg.sender_nickname) + '</span>';
        if (msg.message_type !== "text")
          html += '<span class="message-type-badge">' + esc(msg.message_type) + '</span>';
        html += '<span class="message-time">' + relativeTime(msg.created_at) + '</span>';
        if (!msg.read) html += '<span class="unread-dot"></span>';
        html += '</div>';
        html += '<div class="message-preview">' + esc(msg.message_text) + '</div>';

        card.innerHTML = html;
        return card;
      }

      // Event delegation
      listEl.addEventListener("click", function(e) {
        var target = e.target;
        var tag = target.tagName;
        if (tag === "INPUT" || tag === "BUTTON") return;

        var card = target;
        while (card && !card.classList.contains("message-card")) {
          card = card.parentElement;
        }
        if (!card) return;

        var msgId = parseInt(card.getAttribute("data-id"));
        var msg = null;
        for (var i = 0; i < allMessages.length; i++) {
          if (allMessages[i].id === msgId) { msg = allMessages[i]; break; }
        }
        if (!msg) return;

        hapticFeedback("impact");

        if (expandedId === msgId) {
          collapseCard(card);
          expandedId = null;
          return;
        }

        if (expandedId !== null) {
          var prev = listEl.querySelector('[data-id="' + expandedId + '"]');
          if (prev) collapseCard(prev);
        }

        expandedId = msgId;
        expandCard(card, msg);

        if (!msg.read) {
          msg.read = 1;
          var dot = card.querySelector(".unread-dot");
          if (dot) dot.parentElement.removeChild(dot);
          markRead(msg.id, initData).catch(function() {});
        }
      });

      function collapseCard(card) {
        card.classList.remove("expanded");
        var exp = card.querySelector(".message-expanded");
        if (exp) exp.parentElement.removeChild(exp);
        var ra = card.querySelector(".reply-area");
        if (ra) ra.parentElement.removeChild(ra);
      }

      function expandCard(card, msg) {
        card.classList.add("expanded");

        var full = document.createElement("div");
        full.className = "message-expanded";
        full.textContent = msg.message_text;
        card.appendChild(full);

        if (msg.sender_id && msg.sender_id !== 0) {
          var ra = document.createElement("div");
          ra.className = "reply-area";

          var row = document.createElement("div");
          row.className = "reply-row";

          var input = document.createElement("input");
          input.type = "text";
          input.className = "reply-input";
          input.placeholder = "Reply to " + msg.sender_nickname + "...";
          input.maxLength = 4096;

          var btn = document.createElement("button");
          btn.className = "reply-btn";
          btn.textContent = "Send";

          var status = document.createElement("div");
          status.className = "reply-status";

          row.appendChild(input);
          row.appendChild(btn);
          ra.appendChild(row);
          ra.appendChild(status);
          card.appendChild(ra);

          input.addEventListener("click", function(e) { e.stopPropagation(); });
          btn.addEventListener("click", function(e) { e.stopPropagation(); });

          input.addEventListener("keydown", function(e) {
            if (e.key === "Enter") { e.preventDefault(); doReply(); }
          });

          btn.addEventListener("click", doReply);

          function doReply() {
            var text = input.value.trim();
            if (!text || btn.disabled) return;
            btn.disabled = true;
            btn.textContent = "...";
            status.textContent = "";

            replyToMessage(msg.id, text, initData).then(function() {
              hapticFeedback("success");
              input.value = "";
              status.style.color = "#34c759";
              status.textContent = "Sent!";
              btn.disabled = false;
              btn.textContent = "Send";
              setTimeout(function() { status.textContent = ""; }, 2000);
            }).catch(function(err) {
              hapticFeedback("error");
              status.style.color = "var(--tg-theme-destructive-text-color)";
              status.textContent = err.message || "Failed";
              btn.disabled = false;
              btn.textContent = "Send";
            });
          }
        }
      }

      function loadDashboard() {
        // Fetch stats and recent messages in parallel
        var statsPromise = fetchStats(initData);
        var inboxPromise = fetchInbox(initData, 0);

        Promise.all([statsPromise, inboxPromise]).then(function(results) {
          var stats = results[0];
          var inbox = results[1];

          loadingEl.style.display = "none";
          dashboardEl.style.display = "block";

          // Animate stat counters
          if (firstLoad) {
            animateCounter(statTotalEl, stats.total_messages, 900);
            animateCounter(statUnreadEl, stats.unread, 700);
            animateCounter(statSendersEl, stats.unique_senders, 800);
            animateCounter(statTodayEl, stats.today, 600);
            firstLoad = false;
          } else {
            // On poll refresh, just update instantly
            statTotalEl.textContent = stats.total_messages;
            statUnreadEl.textContent = stats.unread;
            statSendersEl.textContent = stats.unique_senders;
            statTodayEl.textContent = stats.today;
          }

          // Unread badge
          if (stats.unread > 0) {
            badgeEl.textContent = stats.unread;
            badgeEl.style.display = "";
          } else {
            badgeEl.style.display = "none";
          }

          // Recent messages (show max 5)
          var recent = inbox.messages.slice(0, 5);
          if (recent.length === 0) {
            noMsgEl.style.display = "block";
          } else {
            noMsgEl.style.display = "none";

            // Check for new messages on refresh
            var hasNew = false;
            for (var i = 0; i < recent.length; i++) {
              if (!knownIds[recent[i].id]) { hasNew = true; break; }
            }

            if (hasNew) {
              // Prepend new ones at top
              for (var j = recent.length - 1; j >= 0; j--) {
                var msg = recent[j];
                if (knownIds[msg.id]) continue;
                var card = renderCard(msg, false, 0);
                if (!card) continue;
                card.style.animation = "popBounce 0.4s cubic-bezier(0.4, 0, 0.2, 1) both";
                if (listEl.firstChild) {
                  listEl.insertBefore(card, listEl.firstChild);
                } else {
                  listEl.appendChild(card);
                }
              }

              // Trim list to max 5 visible cards
              while (listEl.children.length > 5) {
                listEl.removeChild(listEl.lastChild);
              }
            } else if (listEl.children.length === 0) {
              // First load: render all with staggered animation
              for (var k = 0; k < recent.length; k++) {
                var c = renderCard(recent[k], true, k * 80);
                if (c) listEl.appendChild(c);
              }
            }
          }

          // Start polling
          if (!pollTimer) {
            pollTimer = setInterval(function() {
              loadDashboard();
            }, 5000);
          }

        }).catch(function(err) {
          if (firstLoad) {
            loadingEl.style.display = "none";
            document.getElementById("auth-error").style.display = "block";
            document.getElementById("auth-error-hint").textContent = "Error: " + err.message;
            showDebug();
          }
        });
      }

      loadDashboard();
    }

    boot();
  })();
  </script>
</body>
</html>
