<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Inbox â€” Incognitus</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container" id="app">
    <!-- Loading skeleton -->
    <div id="loading" class="page-content">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
        <div class="skeleton" style="width:100px; height:28px;"></div>
        <div class="skeleton" style="width:40px; height:22px; border-radius:12px;"></div>
      </div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
      <div class="skeleton skeleton-card"></div>
    </div>

    <!-- Inbox content -->
    <div id="inbox" style="display:none;">
      <div class="inbox-header">
        <div class="inbox-title">Inbox</div>
        <div class="unread-badge" id="unread-badge" style="display:none;">0</div>
      </div>
      <div class="message-list" id="message-list"></div>
      <button class="btn-secondary" id="load-more-btn" style="display:none; width:100%; margin-top:12px; text-align:center;">Load more</button>
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="empty-state" style="display:none;">
      <div class="empty-icon">ðŸ“­</div>
      <div class="empty-title">No messages yet</div>
      <div class="empty-hint">Share your link to get started!</div>
    </div>

    <!-- Auth error -->
    <div id="auth-error" style="display:none;">
      <div class="empty-state">
        <div class="empty-icon">ðŸ”’</div>
        <div class="empty-title">Open in Telegram</div>
        <div class="empty-hint" id="auth-error-hint">This page must be opened from the Telegram app.</div>
        <pre id="debug-info" style="font-size:11px; color:var(--tg-theme-hint-color); margin-top:16px; text-align:left; word-break:break-all; white-space:pre-wrap;"></pre>
      </div>
    </div>
  </div>

  <script src="js/telegram.js"></script>
  <script src="js/api.js"></script>
  <script>
    (function() {
      initWebApp();

      // Retry getting initData â€” some clients need a moment
      function tryGetInitData(attempts) {
        var data = getInitData();
        if (data) return data;
        // Also try reading from Telegram.WebApp directly (in case our helper missed it)
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
          return window.Telegram.WebApp.initData;
        }
        return "";
      }

      function showDebug() {
        var debug = document.getElementById("debug-info");
        var info = [];
        var tg = window.Telegram && window.Telegram.WebApp;
        info.push("TG SDK loaded: " + (window.Telegram ? "yes" : "no"));
        info.push("TG.WebApp: " + (tg ? "yes" : "no"));
        if (tg) {
          info.push("platform: " + (tg.platform || "N/A"));
          info.push("version: " + (tg.version || "N/A"));
          info.push("colorScheme: " + (tg.colorScheme || "N/A"));
          info.push("initData length: " + (tg.initData || "").length);
          info.push("initData: '" + (tg.initData || "").substring(0, 200) + "'");
          info.push("initDataUnsafe: " + JSON.stringify(tg.initDataUnsafe || {}));
          info.push("themeParams: " + JSON.stringify(tg.themeParams || {}));
        }
        info.push("URL hash: " + window.location.hash.substring(0, 200));
        info.push("URL search: " + window.location.search);
        info.push("URL: " + window.location.href.substring(0, 200));
        info.push("userAgent: " + navigator.userAgent.substring(0, 100));
        debug.textContent = info.join("\n");
      }

      function startApp(initData) {
        var loadingEl = document.getElementById("loading");
        var inboxEl = document.getElementById("inbox");
        var emptyEl = document.getElementById("empty-state");
        var messageList = document.getElementById("message-list");
        var unreadBadge = document.getElementById("unread-badge");
        var loadMoreBtn = document.getElementById("load-more-btn");

        var currentOffset = 0;
        var pageSize = 50;

        function relativeTime(isoStr) {
          // Python isoformat uses +00:00, JS needs Z or +00:00 â€” only add Z if no timezone info
          var s = isoStr;
          if (!s.endsWith("Z") && s.indexOf("+") === -1 && s.indexOf("T") !== -1) {
            s += "Z";
          }
          var date = new Date(s);
          var now = new Date();
          var diff = Math.floor((now - date) / 1000);
          if (diff < 60) return "just now";
          if (diff < 3600) return Math.floor(diff / 60) + "m ago";
          if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
          if (diff < 604800) return Math.floor(diff / 86400) + "d ago";
          return date.toLocaleDateString();
        }

        function escapeHtml(text) {
          var div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        function renderCard(msg, index) {
          var card = document.createElement("div");
          card.className = "message-card";
          card.style.animationDelay = (index * 50) + "ms";

          var header = '<div class="message-card-header">';
          header += '<span class="sender-badge">' + escapeHtml(msg.sender_nickname) + '</span>';
          if (msg.message_type !== "text") {
            header += '<span class="message-type-badge">' + escapeHtml(msg.message_type) + '</span>';
          }
          header += '<span class="message-time">' + relativeTime(msg.created_at) + '</span>';
          if (!msg.read) {
            header += '<span class="unread-dot"></span>';
          }
          header += '</div>';

          var preview = '<div class="message-preview">' + escapeHtml(msg.message_text) + '</div>';

          card.innerHTML = header + preview;

          card.addEventListener("click", function(e) {
            // Don't toggle if clicking inside reply area
            if (e.target.closest(".reply-area")) return;

            hapticFeedback("impact");

            if (card.classList.contains("expanded")) {
              card.classList.remove("expanded");
              var expanded = card.querySelector(".message-expanded");
              if (expanded) expanded.remove();
              var replyArea = card.querySelector(".reply-area");
              if (replyArea) replyArea.remove();
              var prev = card.querySelector(".message-preview");
              if (prev) prev.style.display = "";
              return;
            }

            card.classList.add("expanded");
            var full = document.createElement("div");
            full.className = "message-expanded";
            full.textContent = msg.message_text;
            card.appendChild(full);

            // Add reply area (only for non-web visitors)
            if (msg.sender_id !== 0) {
              var replyDiv = document.createElement("div");
              replyDiv.className = "reply-area";
              replyDiv.innerHTML =
                '<div style="display:flex; gap:8px; margin-top:10px;">' +
                  '<input type="text" class="reply-input" placeholder="Reply..." maxlength="4096" style="flex:1; padding:8px 12px; border:1.5px solid var(--tg-theme-secondary-bg-color); border-radius:10px; background:var(--tg-theme-bg-color); color:var(--tg-theme-text-color); font-size:14px; font-family:inherit; outline:none;">' +
                  '<button class="reply-btn" style="padding:8px 16px; border:none; border-radius:10px; background:var(--tg-theme-button-color); color:var(--tg-theme-button-text-color); font-size:14px; font-weight:600; cursor:pointer; white-space:nowrap;">Send</button>' +
                '</div>' +
                '<div class="reply-status" style="font-size:12px; margin-top:4px;"></div>';
              card.appendChild(replyDiv);

              var replyInput = replyDiv.querySelector(".reply-input");
              var replyBtn = replyDiv.querySelector(".reply-btn");
              var replyStatus = replyDiv.querySelector(".reply-status");

              replyInput.addEventListener("click", function(e) { e.stopPropagation(); });
              replyInput.addEventListener("keydown", function(e) {
                if (e.key === "Enter" && !e.shiftKey) {
                  e.preventDefault();
                  replyBtn.click();
                }
              });

              replyBtn.addEventListener("click", function(e) {
                e.stopPropagation();
                var text = replyInput.value.trim();
                if (!text) return;
                replyBtn.disabled = true;
                replyBtn.textContent = "...";
                replyStatus.textContent = "";
                replyStatus.style.color = "";

                replyToMessage(msg.id, text, initData).then(function() {
                  hapticFeedback("success");
                  replyInput.value = "";
                  replyStatus.style.color = "#34c759";
                  replyStatus.textContent = "Sent!";
                  replyBtn.disabled = false;
                  replyBtn.textContent = "Send";
                  setTimeout(function() { replyStatus.textContent = ""; }, 2000);
                }).catch(function(err) {
                  hapticFeedback("error");
                  replyStatus.style.color = "var(--tg-theme-destructive-text-color)";
                  replyStatus.textContent = err.message;
                  replyBtn.disabled = false;
                  replyBtn.textContent = "Send";
                });
              });
            }

            if (!msg.read) {
              msg.read = 1;
              var dot = card.querySelector(".unread-dot");
              if (dot) dot.remove();
              markRead(msg.id, initData).catch(function() {});
            }
          });

          return card;
        }

        function loadInbox(offset) {
          fetchInbox(initData, offset).then(function(data) {
            loadingEl.style.display = "none";

            if (data.messages.length === 0 && offset === 0) {
              emptyEl.style.display = "block";
              return;
            }

            inboxEl.style.display = "block";

            if (data.unread_count > 0) {
              unreadBadge.textContent = data.unread_count;
              unreadBadge.style.display = "";
            }

            data.messages.forEach(function(msg, i) {
              messageList.appendChild(renderCard(msg, i));
            });

            currentOffset = offset + data.messages.length;

            if (data.messages.length >= pageSize) {
              loadMoreBtn.style.display = "";
            } else {
              loadMoreBtn.style.display = "none";
            }
          }).catch(function(err) {
            loadingEl.style.display = "none";
            document.getElementById("auth-error").style.display = "block";
            document.getElementById("auth-error-hint").textContent = "API error: " + err.message;
            showDebug();
          });
        }

        loadMoreBtn.addEventListener("click", function() {
          loadInbox(currentOffset);
        });

        loadInbox(0);
      }

      // Try immediately, then retry after a short delay if empty
      var initData = tryGetInitData();
      if (initData) {
        startApp(initData);
        return;
      }

      // Retry after 500ms â€” some Telegram clients are slow to inject initData
      setTimeout(function() {
        initData = tryGetInitData();
        if (initData) {
          startApp(initData);
          return;
        }

        // Final attempt after 1.5s
        setTimeout(function() {
          initData = tryGetInitData();
          if (initData) {
            startApp(initData);
            return;
          }

          // Give up â€” show error with debug
          document.getElementById("loading").style.display = "none";
          document.getElementById("auth-error").style.display = "block";
          showDebug();
        }, 1000);
      }, 500);
    })();
  </script>
</body>
</html>
