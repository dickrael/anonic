<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard ‚Äî Incognitus</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=10">
  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .dashboard {
      padding-top: 8px;
      position: relative;
    }
    /* Floating gradient blobs behind content */
    .bg-blob {
      position: fixed;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
      pointer-events: none;
      z-index: -1;
    }
    .bg-blob-1 { width: 200px; height: 200px; top: -40px; left: -40px; }
    .bg-blob-2 { width: 180px; height: 180px; bottom: 60px; right: -50px; }
    .bg-blob-3 { width: 140px; height: 140px; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    /* ===== Profile Header ===== */
    .profile-header {
      text-align: center;
      margin-bottom: 28px;
      opacity: 0;
      animation: fadeSlideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.05s forwards;
    }
    .profile-avatar {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--tg-theme-button-color), var(--tg-theme-link-color));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      box-shadow: 0 6px 24px rgba(64, 167, 227, 0.3);
      opacity: 0;
      animation: popBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.15s forwards;
    }
    .profile-avatar span {
      font-size: 36px;
      line-height: 1;
    }
    .profile-nickname {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
      opacity: 0;
      animation: textReveal 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.35s forwards;
    }
    .profile-member-since {
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      opacity: 0;
      animation: textReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards;
    }
    @keyframes textReveal {
      from { opacity: 0; transform: translateY(8px); filter: blur(4px); }
      to { opacity: 1; transform: translateY(0); filter: blur(0); }
    }

    /* ===== Stats Grid ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 18px 14px;
      text-align: center;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: scale(0.85) translateY(16px);
      animation: statPopIn 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @media (prefers-color-scheme: light) {
      .stat-card {
        background: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
    }
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      animation: cardShine 2s ease-in-out 1s forwards;
    }
    @keyframes cardShine {
      to { left: 100%; }
    }
    .stat-card:nth-child(1) { animation-delay: 0.2s; }
    .stat-card:nth-child(2) { animation-delay: 0.3s; }
    .stat-card:nth-child(3) { animation-delay: 0.4s; }
    .stat-card:nth-child(4) { animation-delay: 0.5s; }

    @keyframes statPopIn {
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stat-icon { font-size: 26px; margin-bottom: 8px; display: block; }
    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--tg-theme-text-color);
      line-height: 1;
      font-variant-numeric: tabular-nums;
      opacity: 0;
      filter: blur(6px);
      transition: opacity 0.4s ease, filter 0.4s ease;
    }
    .stat-value.revealed {
      opacity: 1;
      filter: blur(0);
    }
    .stat-label {
      font-size: 11px;
      color: var(--tg-theme-hint-color);
      font-weight: 600;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    /* ===== Info Cards ===== */
    .info-section {
      margin-top: 8px;
      opacity: 0;
      animation: fadeSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.65s forwards;
    }
    .info-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    @media (prefers-color-scheme: light) {
      .info-card {
        background: rgba(255, 255, 255, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
    }
    .info-icon { font-size: 22px; flex-shrink: 0; }
    .info-content { flex: 1; min-width: 0; }
    .info-label {
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      font-weight: 500;
    }
    .info-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--tg-theme-text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .info-action { flex-shrink: 0; }
    .copy-btn {
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
    }
    .copy-btn:active { transform: scale(0.92); }
    .copy-btn.copied {
      background: #34c759;
      animation: popBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }

    /* ===== Skeleton ===== */
    .skeleton-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .skeleton-stat { height: 100px; border-radius: 16px; }
    .skeleton-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 28px;
    }
    .skeleton-avatar-sm { width: 72px; height: 72px; border-radius: 50%; margin-bottom: 12px; }
    .skeleton-name { width: 120px; height: 22px; margin-bottom: 6px; }
    .skeleton-sub { width: 160px; height: 14px; }
    .skeleton-info { height: 52px; border-radius: 14px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Loading skeleton -->
    <div id="loading" class="page-content">
      <div class="skeleton-profile">
        <div class="skeleton skeleton-avatar-sm"></div>
        <div class="skeleton skeleton-name"></div>
        <div class="skeleton skeleton-sub"></div>
      </div>
      <div class="skeleton-stats">
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
      </div>
      <div class="skeleton skeleton-info"></div>
      <div class="skeleton skeleton-info"></div>
    </div>

    <!-- Background blobs (colored dynamically by JS) -->
    <div class="bg-blob bg-blob-1" id="blob1"></div>
    <div class="bg-blob bg-blob-2" id="blob2"></div>
    <div class="bg-blob bg-blob-3" id="blob3"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard" style="display:none">
      <div class="profile-header">
        <div class="profile-avatar">
          <span id="avatar-letter">?</span>
        </div>
        <div class="profile-nickname" id="profile-nickname"></div>
        <div class="profile-member-since" id="profile-since"></div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-icon">üì®</span>
          <div class="stat-value" id="stat-received">0</div>
          <div class="stat-label">Received</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">üì§</span>
          <div class="stat-value" id="stat-sent">0</div>
          <div class="stat-label">Sent</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">üö´</span>
          <div class="stat-value" id="stat-blocked">0</div>
          <div class="stat-label">Blocked</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">üîÑ</span>
          <div class="stat-value" id="stat-revokes">0</div>
          <div class="stat-label">Revokes</div>
        </div>
      </div>

      <div class="info-section">
        <div class="info-card">
          <span class="info-icon">üìÖ</span>
          <div class="info-content">
            <div class="info-label">Member since</div>
            <div class="info-value" id="info-registered"></div>
          </div>
        </div>
        <div class="info-card">
          <span class="info-icon">‚è≥</span>
          <div class="info-content">
            <div class="info-label">Days active</div>
            <div class="info-value" id="info-days"></div>
          </div>
        </div>
        <div class="info-card">
          <span class="info-icon">üîó</span>
          <div class="info-content">
            <div class="info-label">Your link</div>
            <div class="info-value" id="info-link"></div>
          </div>
          <div class="info-action">
            <button class="copy-btn" id="copy-link-btn">Copy</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth error -->
    <div id="auth-error" style="display:none">
      <div class="empty-state">
        <div class="empty-icon">üîí</div>
        <div class="empty-title">Open in Telegram</div>
        <div class="empty-hint" id="auth-error-hint">This page must be opened from the Telegram app.</div>
        <pre id="debug-info" style="font-size:11px;color:var(--tg-theme-hint-color);margin-top:16px;text-align:left;word-break:break-all;white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>

  <script src="js/telegram.js?v=10"></script>
  <script src="js/api.js?v=10"></script>
  <script>
  (function() {
    "use strict";
    initWebApp();

    function tryGetInitData() {
      var d = getInitData();
      if (d) return d;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData)
        return window.Telegram.WebApp.initData;
      return "";
    }

    function boot() {
      var data = tryGetInitData();
      if (data) { startApp(data); return; }
      setTimeout(function() {
        data = tryGetInitData();
        if (data) { startApp(data); return; }
        setTimeout(function() {
          data = tryGetInitData();
          if (data) { startApp(data); return; }
          document.getElementById("loading").style.display = "none";
          document.getElementById("auth-error").style.display = "block";
          showDebug();
        }, 1000);
      }, 500);
    }

    function showDebug() {
      var d = document.getElementById("debug-info");
      var tg = window.Telegram && window.Telegram.WebApp;
      var lines = ["TG: " + (tg ? "yes" : "no")];
      if (tg) {
        lines.push("platform: " + tg.platform);
        lines.push("initData len: " + (tg.initData || "").length);
      }
      d.textContent = lines.join("\n");
    }

    // Animated count-up with easing + blur reveal
    function animateValue(el, target, duration, delay) {
      delay = delay || 0;
      setTimeout(function() {
        el.classList.add("revealed");
        if (target === 0) { el.textContent = "0"; return; }
        var startTime = null;
        duration = duration || 1000;
        function step(ts) {
          if (!startTime) startTime = ts;
          var p = Math.min((ts - startTime) / duration, 1);
          var eased = 1 - Math.pow(1 - p, 4);
          el.textContent = Math.round(target * eased);
          if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }, delay);
    }

    function startApp(initData) {
      var loadingEl   = document.getElementById("loading");
      var dashboardEl = document.getElementById("dashboard");

      fetchDashboard(initData).then(function(data) {
        loadingEl.style.display = "none";
        dashboardEl.style.display = "block";

        // Profile header
        var nick = data.nickname || "?";
        var avatarEmojis = ["ü¶ä","üêº","ü¶ã","üê¨","ü¶Ñ","üêß","ü¶Å","üê∏","ü¶â","üê∫","ü¶à","üêô","ü¶ú","üêπ","ü¶ù","üêØ","üê®","ü¶©","üêª","üê∞","ü¶Ä","üêù","üê≥","ü¶é","üêøÔ∏è","ü¶á","üêÆ","üêî","üê≤","üé≠","üé™","üé®","üéØ","üé≤","üåà","üå∏","üçÑ","üåµ","üîÆ","ü™ê","üíé","üßä","üéÄ","ü™∏"];
        var hash = 0;
        for (var ci = 0; ci < nick.length; ci++) hash = hash * 31 + nick.charCodeAt(ci);
        hash = Math.abs(hash);
        document.getElementById("avatar-letter").textContent = avatarEmojis[hash % avatarEmojis.length];

        // Random gradient for avatar
        var gradients = [
          ["#FF6B6B","#EE5A24"],["#A29BFE","#6C5CE7"],["#55E6C1","#1ABC9C"],
          ["#FECA57","#FF9F43"],["#FF9FF3","#F368E0"],["#48DBFB","#0ABDE3"],
          ["#FF6348","#FF4757"],["#7BED9F","#2ED573"],["#70A1FF","#1E90FF"],
          ["#FFA502","#E17055"],["#DCDDE1","#A4B0BD"],["#FD79A8","#E84393"],
          ["#BADC58","#6AB04C"],["#F8C291","#E55039"],["#82CCDD","#3C6382"],
          ["#B8E994","#78E08F"],["#FDA7DF","#D980FA"],["#F7D794","#F5CD79"]
        ];
        var grad = gradients[hash % gradients.length];
        var avatarEl = document.querySelector(".profile-avatar");
        avatarEl.style.background = "linear-gradient(135deg, " + grad[0] + ", " + grad[1] + ")";
        avatarEl.style.boxShadow = "0 6px 24px " + grad[0] + "40";

        // Color the background blobs
        document.getElementById("blob1").style.background = grad[0];
        document.getElementById("blob2").style.background = grad[1];
        document.getElementById("blob3").style.background = grad[0];
        document.getElementById("profile-nickname").textContent = nick;
        document.getElementById("profile-since").textContent = "Member since " + (data.registered_at || "‚Äî");

        // Animate stat counters with staggered blur reveal
        animateValue(document.getElementById("stat-received"), data.messages_received || 0, 1000, 300);
        animateValue(document.getElementById("stat-sent"), data.messages_sent || 0, 900, 450);
        animateValue(document.getElementById("stat-blocked"), data.blocked_count || 0, 800, 600);
        animateValue(document.getElementById("stat-revokes"), data.revoke_count || 0, 700, 750);

        // Info cards
        document.getElementById("info-registered").textContent = data.registered_at || "‚Äî";

        var days = data.days_since_registration || 0;
        var dayText = days === 1 ? "1 day" : days + " days";
        document.getElementById("info-days").textContent = dayText;

        var fullLink = "https://t.me/incognitusbot?start=" + (data.link_token || "");
        document.getElementById("info-link").textContent = fullLink;

        // Copy button
        var copyBtn = document.getElementById("copy-link-btn");
        copyBtn.addEventListener("click", function() {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(fullLink).then(function() {
              onCopied();
            }).catch(function() {
              fallbackCopy(fullLink);
            });
          } else {
            fallbackCopy(fullLink);
          }
        });

        function fallbackCopy(text) {
          var ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand("copy"); onCopied(); } catch(e) {}
          document.body.removeChild(ta);
        }

        function onCopied() {
          hapticFeedback("success");
          copyBtn.textContent = "Copied!";
          copyBtn.classList.add("copied");
          setTimeout(function() {
            copyBtn.textContent = "Copy";
            copyBtn.classList.remove("copied");
          }, 2000);
        }

      }).catch(function(err) {
        loadingEl.style.display = "none";
        document.getElementById("auth-error").style.display = "block";
        document.getElementById("auth-error-hint").textContent = "Error: " + err.message;
        showDebug();
      });
    }

    boot();
  })();
  </script>
</body>
</html>
