<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard â€” Incognitus</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=16">
  <style>
    *, *::before, *::after {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-touch-callout: none !important;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Gradient Background ===== */
    body {
      background: linear-gradient(145deg, #0f0c29, #302b63, #24243e) !important;
      min-height: 100vh;
    }
    /* Light mode: soft pastel gradient */
    body.theme-light {
      background: linear-gradient(145deg, #e8eaf6, #f3e5f5, #e0f2f1) !important;
    }

    .dashboard {
      padding-top: 8px;
      position: relative;
    }

    /* Floating gradient blobs */
    .bg-blob {
      position: fixed;
      border-radius: 50%;
      filter: blur(90px);
      opacity: 0.25;
      pointer-events: none;
      z-index: 0;
      animation: blobFloat 8s ease-in-out infinite alternate;
    }
    .bg-blob-1 { width: 220px; height: 220px; top: -50px; left: -50px; animation-delay: 0s; }
    .bg-blob-2 { width: 200px; height: 200px; bottom: 40px; right: -60px; animation-delay: -3s; }
    .bg-blob-3 { width: 160px; height: 160px; top: 45%; left: 50%; transform: translate(-50%, -50%); animation-delay: -5s; }
    body.theme-light .bg-blob { opacity: 0.35; }

    @keyframes blobFloat {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(15px, -20px) scale(1.1); }
    }
    .bg-blob-3 {
      animation-name: blobFloat3;
    }
    @keyframes blobFloat3 {
      0% { transform: translate(-50%, -50%) scale(1); }
      100% { transform: translate(-40%, -55%) scale(1.15); }
    }

    /* Dark gradient bg needs light text */
    .dashboard { color: #f0f0f5; }
    .dashboard .profile-nickname { color: #ffffff; }
    .dashboard .profile-member-since { color: rgba(255,255,255,0.55); }
    .dashboard .stat-value { color: #ffffff !important; }
    .dashboard .stat-label { color: rgba(255,255,255,0.5); }
    .dashboard .info-label { color: rgba(255,255,255,0.5); }
    .dashboard .info-value { color: #f0f0f5; }

    /* Light mode: use dark text */
    body.theme-light .dashboard { color: #1a1a2e; }
    body.theme-light .dashboard .profile-nickname { color: #1a1a2e; }
    body.theme-light .dashboard .profile-member-since { color: rgba(0,0,0,0.45); }
    body.theme-light .dashboard .stat-value { color: #1a1a2e !important; }
    body.theme-light .dashboard .stat-label { color: rgba(0,0,0,0.45); }
    body.theme-light .dashboard .info-label { color: rgba(0,0,0,0.45); }
    body.theme-light .dashboard .info-value { color: #1a1a2e; }

    /* ===== Profile Header ===== */
    .profile-header {
      text-align: center;
      margin-bottom: 28px;
      opacity: 0;
      animation: fadeSlideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.05s forwards;
    }
    .avatar-frame-wrapper {
      position: relative;
      width: 130px;
      height: 130px;
      margin: 0 auto 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .profile-avatar {
      width: 105px;
      height: 105px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--tg-theme-button-color), var(--tg-theme-link-color));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      box-shadow: 0 8px 28px rgba(64, 167, 227, 0.3);
      opacity: 0;
      animation: popBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.15s forwards;
    }
    .profile-avatar span {
      font-size: 52px;
      line-height: 1;
    }
    .avatar-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 130px;
      height: 130px;
      pointer-events: none;
      z-index: 1;
    }
    .profile-nickname {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
      opacity: 0;
      animation: textReveal 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.35s forwards;
    }
    .profile-member-since {
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      opacity: 0;
      animation: textReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards;
    }
    @keyframes textReveal {
      from { opacity: 0; transform: translateY(8px); filter: blur(4px); }
      to { opacity: 1; transform: translateY(0); filter: blur(0); }
    }

    /* ===== Stats Grid ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 18px 14px;
      text-align: center;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: scale(0.85) translateY(16px);
      animation: statPopIn 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    body.theme-light .stat-card {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      animation: cardShine 2s ease-in-out 1s forwards;
    }
    @keyframes cardShine {
      to { left: 100%; }
    }
    .stat-card:nth-child(1) { animation-delay: 0.2s; }
    .stat-card:nth-child(2) { animation-delay: 0.3s; }
    .stat-card:nth-child(3) { animation-delay: 0.4s; }
    .stat-card:nth-child(4) { animation-delay: 0.5s; }

    @keyframes statPopIn {
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stat-icon { font-size: 26px; margin-bottom: 8px; display: block; }
    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--tg-theme-text-color);
      line-height: 1;
      font-variant-numeric: tabular-nums;
      opacity: 0;
      filter: blur(6px);
      transition: opacity 0.4s ease, filter 0.4s ease;
    }
    .stat-value.revealed {
      opacity: 1;
      filter: blur(0);
    }
    .stat-label {
      font-size: 11px;
      color: var(--tg-theme-hint-color);
      font-weight: 600;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    /* ===== Info Cards ===== */
    .info-section {
      margin-top: 8px;
      opacity: 0;
      animation: fadeSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.65s forwards;
    }
    .info-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    body.theme-light .info-card {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .info-icon { font-size: 22px; flex-shrink: 0; }
    .info-content { flex: 1; min-width: 0; }
    .info-label {
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      font-weight: 500;
    }
    .info-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--tg-theme-text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .info-action { flex-shrink: 0; }
    .copy-btn {
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.15s;
    }
    .copy-btn:active { transform: scale(0.92); }
    .copy-btn.copied {
      background: #34c759;
      animation: popBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }

    /* ===== Share Story Button ===== */
    .story-btn-wrapper {
      margin-top: 18px;
      opacity: 0;
      animation: fadeSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.8s forwards;
    }
    .story-btn {
      width: 100%;
      padding: 15px 20px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.15s, opacity 0.2s;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.35);
    }
    .story-btn:active { transform: scale(0.96); }
    body.theme-light .story-btn {
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.25);
    }

    /* ===== Skeleton ===== */
    .skeleton-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .skeleton-stat { height: 100px; border-radius: 16px; }
    .skeleton-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 28px;
    }
    .skeleton-avatar-sm { width: 130px; height: 130px; border-radius: 50%; margin-bottom: 14px; }
    .skeleton-name { width: 120px; height: 22px; margin-bottom: 6px; }
    .skeleton-sub { width: 160px; height: 14px; }
    .skeleton-info { height: 52px; border-radius: 14px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Loading skeleton -->
    <div id="loading" class="page-content">
      <div class="skeleton-profile">
        <div class="skeleton skeleton-avatar-sm"></div>
        <div class="skeleton skeleton-name"></div>
        <div class="skeleton skeleton-sub"></div>
      </div>
      <div class="skeleton-stats">
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
        <div class="skeleton skeleton-stat"></div>
      </div>
      <div class="skeleton skeleton-info"></div>
      <div class="skeleton skeleton-info"></div>
    </div>

    <!-- Background blobs (colored dynamically by JS) -->
    <div class="bg-blob bg-blob-1" id="blob1"></div>
    <div class="bg-blob bg-blob-2" id="blob2"></div>
    <div class="bg-blob bg-blob-3" id="blob3"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard" style="display:none">
      <div class="profile-header">
        <div class="avatar-frame-wrapper">
          <div class="profile-avatar" id="profile-avatar">
            <span id="avatar-letter">?</span>
          </div>
          <img class="avatar-frame" src="https://lazez.uz/addons/frame.webp" alt="" />
        </div>
        <div class="profile-nickname" id="profile-nickname"></div>
        <div class="profile-member-since" id="profile-since"></div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-icon">ğŸ“¨</span>
          <div class="stat-value" id="stat-received">0</div>
          <div class="stat-label" data-i18n="received">Received</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ğŸ“¤</span>
          <div class="stat-value" id="stat-sent">0</div>
          <div class="stat-label" data-i18n="sent">Sent</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ğŸš«</span>
          <div class="stat-value" id="stat-blocked">0</div>
          <div class="stat-label" data-i18n="blocked">Blocked</div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ğŸ”„</span>
          <div class="stat-value" id="stat-revokes">0</div>
          <div class="stat-label" data-i18n="revokes">Revokes</div>
        </div>
      </div>

      <div class="info-section">
        <div class="info-card">
          <span class="info-icon">ğŸ“…</span>
          <div class="info-content">
            <div class="info-label" data-i18n="member_since">Member since</div>
            <div class="info-value" id="info-registered"></div>
          </div>
        </div>
        <div class="info-card">
          <span class="info-icon">â³</span>
          <div class="info-content">
            <div class="info-label" data-i18n="days_active">Days active</div>
            <div class="info-value" id="info-days"></div>
          </div>
        </div>
        <div class="info-card">
          <span class="info-icon">ğŸ”—</span>
          <div class="info-content">
            <div class="info-label" data-i18n="your_link">Your link</div>
            <div class="info-value" id="info-link"></div>
          </div>
          <div class="info-action">
            <button class="copy-btn" id="copy-link-btn" data-i18n="copy">Copy</button>
          </div>
        </div>
      </div>

      <div class="story-btn-wrapper">
        <button class="story-btn" id="share-story-btn">
          <span>ğŸ“–</span>
          <span data-i18n="share_story">Share to Story</span>
        </button>
      </div>
    </div>

    <!-- Auth error -->
    <div id="auth-error" style="display:none">
      <div class="empty-state">
        <div class="empty-icon">ğŸ”’</div>
        <div class="empty-title" data-i18n="open_in_tg">Open in Telegram</div>
        <div class="empty-hint" id="auth-error-hint" data-i18n="open_in_tg_hint">This page must be opened from the Telegram app.</div>
        <pre id="debug-info" style="font-size:11px;color:var(--tg-theme-hint-color);margin-top:16px;text-align:left;word-break:break-all;white-space:pre-wrap"></pre>
      </div>
    </div>
  </div>

  <script src="js/telegram.js?v=16"></script>
  <script src="js/api.js?v=16"></script>
  <script>
  (function() {
    "use strict";
    initWebApp();

    // Disable text selection and context menu
    document.addEventListener("selectstart", function(e) { e.preventDefault(); });
    document.addEventListener("contextmenu", function(e) { e.preventDefault(); });
    document.addEventListener("copy", function(e) { e.preventDefault(); });

    // Detect light/dark theme from Telegram
    (function detectTheme() {
      var tg = window.Telegram && window.Telegram.WebApp;
      var bg = (tg && tg.themeParams && tg.themeParams.bg_color) || "";
      // Parse hex color brightness
      if (bg) {
        var hex = bg.replace("#", "");
        var r = parseInt(hex.substring(0, 2), 16) || 0;
        var g = parseInt(hex.substring(2, 4), 16) || 0;
        var b = parseInt(hex.substring(4, 6), 16) || 0;
        var brightness = (r * 299 + g * 587 + b * 114) / 1000;
        if (brightness > 128) document.body.classList.add("theme-light");
      }
    })();

    function tryGetInitData() {
      var d = getInitData();
      if (d) return d;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData)
        return window.Telegram.WebApp.initData;
      return "";
    }

    function boot() {
      var data = tryGetInitData();
      if (data) { startApp(data); return; }
      setTimeout(function() {
        data = tryGetInitData();
        if (data) { startApp(data); return; }
        setTimeout(function() {
          data = tryGetInitData();
          if (data) { startApp(data); return; }
          document.getElementById("loading").style.display = "none";
          document.getElementById("auth-error").style.display = "block";
          showDebug();
        }, 1000);
      }, 500);
    }

    // ---- i18n ----
    var I18N = {
      en: {
        received: "Received", sent: "Sent", blocked: "Blocked", revokes: "Revokes",
        member_since: "Member since", days_active: "Days active", your_link: "Your link",
        copy: "Copy", copied: "Copied!", last_seen: "Last seen",
        just_now: "Just now", minutes_ago: "{n}m ago", hours_ago: "{n}h ago", days_ago: "{n}d ago",
        share_story: "Share to Story",
        open_in_tg: "Open in Telegram", open_in_tg_hint: "This page must be opened from the Telegram app."
      },
      ru: {
        received: "ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾", sent: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾", blocked: "Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾", revokes: "Ğ¡Ğ±Ñ€Ğ¾ÑÑ‹",
        member_since: "Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº Ñ", days_active: "Ğ”Ğ½ĞµĞ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸", your_link: "Ğ’Ğ°ÑˆĞ° ÑÑÑ‹Ğ»ĞºĞ°",
        copy: "ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ", copied: "Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!", last_seen: "Ğ‘Ñ‹Ğ»(Ğ°)",
        just_now: "Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾", minutes_ago: "{n} Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´", hours_ago: "{n} Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´", days_ago: "{n} Ğ´Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´",
        share_story: "ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ² Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸",
        open_in_tg: "ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ² Telegram", open_in_tg_hint: "Ğ­Ñ‚Ñƒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ· Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Telegram."
      },
      fa: {
        received: "Ø¯Ø±ÛŒØ§ÙØªâ€ŒØ´Ø¯Ù‡", sent: "Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡", blocked: "Ù…Ø³Ø¯ÙˆØ¯Ø´Ø¯Ù‡", revokes: "Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ",
        member_since: "Ø¹Ø¶Ùˆ Ø§Ø²", days_active: "Ø±ÙˆØ² ÙØ¹Ø§Ù„ÛŒØª", your_link: "Ù„ÛŒÙ†Ú© Ø´Ù…Ø§",
        copy: "Ú©Ù¾ÛŒ", copied: "Ú©Ù¾ÛŒ Ø´Ø¯!", last_seen: "Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯",
        just_now: "Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†", minutes_ago: "{n} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´", hours_ago: "{n} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´", days_ago: "{n} Ø±ÙˆØ² Ù¾ÛŒØ´",
        share_story: "Ø§Ø´ØªØ±Ø§Ú© Ø¯Ø± Ø§Ø³ØªÙˆØ±ÛŒ",
        open_in_tg: "Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯", open_in_tg_hint: "Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø§Ù¾ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§Ø² Ø´ÙˆØ¯."
      },
      ar: {
        received: "Ù…Ø³ØªÙ„Ù…Ø©", sent: "Ù…Ø±Ø³Ù„Ø©", blocked: "Ù…Ø­Ø¸ÙˆØ±Ø©", revokes: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†",
        member_since: "Ø¹Ø¶Ùˆ Ù…Ù†Ø°", days_active: "Ø£ÙŠØ§Ù… Ø§Ù„Ù†Ø´Ø§Ø·", your_link: "Ø±Ø§Ø¨Ø·Ùƒ",
        copy: "Ù†Ø³Ø®", copied: "ØªÙ… Ø§Ù„Ù†Ø³Ø®!", last_seen: "Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±",
        just_now: "Ø§Ù„Ø¢Ù†", minutes_ago: "Ù…Ù†Ø° {n} Ø¯Ù‚ÙŠÙ‚Ø©", hours_ago: "Ù…Ù†Ø° {n} Ø³Ø§Ø¹Ø©", days_ago: "Ù…Ù†Ø° {n} ÙŠÙˆÙ…",
        share_story: "Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù‚ØµØ©",
        open_in_tg: "Ø§ÙØªØ­ ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", open_in_tg_hint: "ÙŠØ¬Ø¨ ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…."
      }
    };

    var currentLang = "en";

    function t(key) {
      var dict = I18N[currentLang] || I18N.en;
      return dict[key] || (I18N.en[key] || key);
    }

    function applyTranslations() {
      var els = document.querySelectorAll("[data-i18n]");
      for (var i = 0; i < els.length; i++) {
        var key = els[i].getAttribute("data-i18n");
        els[i].textContent = t(key);
      }
      // RTL support for Arabic and Persian
      if (currentLang === "ar" || currentLang === "fa") {
        document.documentElement.setAttribute("dir", "rtl");
      }
    }

    function showDebug() {
      var d = document.getElementById("debug-info");
      var tg = window.Telegram && window.Telegram.WebApp;
      var lines = ["TG: " + (tg ? "yes" : "no")];
      if (tg) {
        lines.push("platform: " + tg.platform);
        lines.push("initData len: " + (tg.initData || "").length);
      }
      d.textContent = lines.join("\n");
    }

    // Smart relative time helper
    function relativeTime(isoStr) {
      if (!isoStr) return "â€”";
      try {
        var d = new Date(isoStr);
        var diff = Date.now() - d.getTime();
        var min = Math.floor(diff / 60000);
        var hrs = Math.floor(diff / 3600000);
        var days = Math.floor(diff / 86400000);
        if (min < 1) return t("just_now");
        if (min < 60) return t("minutes_ago").replace("{n}", min);
        if (hrs < 24) return t("hours_ago").replace("{n}", hrs);
        return t("days_ago").replace("{n}", days);
      } catch(e) { return "â€”"; }
    }

    // Animated count-up with easing + blur reveal
    function animateValue(el, target, duration, delay) {
      delay = delay || 0;
      setTimeout(function() {
        el.classList.add("revealed");
        if (target === 0) { el.textContent = "0"; return; }
        var startTime = null;
        duration = duration || 1000;
        function step(ts) {
          if (!startTime) startTime = ts;
          var p = Math.min((ts - startTime) / duration, 1);
          var eased = 1 - Math.pow(1 - p, 4);
          el.textContent = Math.round(target * eased);
          if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }, delay);
    }

    function startApp(initData) {
      var loadingEl   = document.getElementById("loading");
      var dashboardEl = document.getElementById("dashboard");

      fetchDashboard(initData).then(function(data) {
        // Set language and apply translations
        currentLang = data.lang || "en";
        applyTranslations();

        loadingEl.style.display = "none";
        dashboardEl.style.display = "block";

        // Profile header
        var nick = data.nickname || "?";
        var avatarEmojis = ["ğŸ¦Š","ğŸ¼","ğŸ¦‹","ğŸ¬","ğŸ¦„","ğŸ§","ğŸ¦","ğŸ¸","ğŸ¦‰","ğŸº","ğŸ¦ˆ","ğŸ™","ğŸ¦œ","ğŸ¹","ğŸ¦","ğŸ¯","ğŸ¨","ğŸ¦©","ğŸ»","ğŸ°","ğŸ¦€","ğŸ","ğŸ³","ğŸ¦","ğŸ¿ï¸","ğŸ¦‡","ğŸ®","ğŸ”","ğŸ²","ğŸ­","ğŸª","ğŸ¨","ğŸ¯","ğŸ²","ğŸŒˆ","ğŸŒ¸","ğŸ„","ğŸŒµ","ğŸ”®","ğŸª","ğŸ’","ğŸ§Š","ğŸ€","ğŸª¸"];
        var hash = 0;
        for (var ci = 0; ci < nick.length; ci++) hash = hash * 31 + nick.charCodeAt(ci);
        hash = Math.abs(hash);
        document.getElementById("avatar-letter").textContent = avatarEmojis[hash % avatarEmojis.length];

        // Random gradient for avatar
        var gradients = [
          ["#FF6B6B","#EE5A24"],["#A29BFE","#6C5CE7"],["#55E6C1","#1ABC9C"],
          ["#FECA57","#FF9F43"],["#FF9FF3","#F368E0"],["#48DBFB","#0ABDE3"],
          ["#FF6348","#FF4757"],["#7BED9F","#2ED573"],["#70A1FF","#1E90FF"],
          ["#FFA502","#E17055"],["#DCDDE1","#A4B0BD"],["#FD79A8","#E84393"],
          ["#BADC58","#6AB04C"],["#F8C291","#E55039"],["#82CCDD","#3C6382"],
          ["#B8E994","#78E08F"],["#FDA7DF","#D980FA"],["#F7D794","#F5CD79"]
        ];
        var grad = gradients[hash % gradients.length];
        var avatarEl = document.querySelector(".profile-avatar");
        avatarEl.style.background = "linear-gradient(135deg, " + grad[0] + ", " + grad[1] + ")";
        avatarEl.style.boxShadow = "0 6px 24px " + grad[0] + "40";

        // Color the background blobs
        document.getElementById("blob1").style.background = grad[0];
        document.getElementById("blob2").style.background = grad[1];
        document.getElementById("blob3").style.background = grad[0];
        document.getElementById("profile-nickname").textContent = nick;

        // Last seen under profile pic
        var lastSeenText = t("last_seen") + " " + relativeTime(data.last_activity);
        document.getElementById("profile-since").textContent = lastSeenText;

        // Animate stat counters with staggered blur reveal
        animateValue(document.getElementById("stat-received"), data.messages_received || 0, 1000, 300);
        animateValue(document.getElementById("stat-sent"), data.messages_sent || 0, 900, 450);
        animateValue(document.getElementById("stat-blocked"), data.blocked_count || 0, 800, 600);
        animateValue(document.getElementById("stat-revokes"), data.revoke_count || 0, 700, 750);

        // Info cards â€” member since with date + relative time in parens
        var regDisplay = "â€”";
        if (data.registered_at) {
          try {
            var rd = new Date(data.registered_at);
            var locale = currentLang === "fa" ? "fa-IR" : currentLang === "ar" ? "ar-SA" : currentLang === "ru" ? "ru-RU" : "en-US";
            var dateStr = rd.toLocaleDateString(locale, { year: "numeric", month: "short", day: "numeric" });
            regDisplay = dateStr + " (" + relativeTime(data.registered_at) + ")";
          } catch(e) {}
        }
        document.getElementById("info-registered").textContent = regDisplay;

        // Days active â€” computed from registration
        var daysActive = 0;
        if (data.registered_at) {
          try { daysActive = Math.floor((Date.now() - new Date(data.registered_at).getTime()) / 86400000); } catch(e) {}
        }
        document.getElementById("info-days").textContent = daysActive;

        var botUser = data.bot_username || "ClearSayBot";
        var fullLink = "https://t.me/" + botUser + "?start=" + (data.link_token || "");
        document.getElementById("info-link").textContent = fullLink;

        // Copy button
        var copyBtn = document.getElementById("copy-link-btn");
        copyBtn.addEventListener("click", function() {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(fullLink).then(function() {
              onCopied();
            }).catch(function() {
              fallbackCopy(fullLink);
            });
          } else {
            fallbackCopy(fullLink);
          }
        });

        function fallbackCopy(text) {
          var ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand("copy"); onCopied(); } catch(e) {}
          document.body.removeChild(ta);
        }

        function onCopied() {
          hapticFeedback("success");
          copyBtn.textContent = t("copied");
          copyBtn.classList.add("copied");
          setTimeout(function() {
            copyBtn.textContent = t("copy");
            copyBtn.classList.remove("copied");
          }, 2000);
        }

        // ---- Share to Story ----
        var storyBtn = document.getElementById("share-story-btn");
        var tg = window.Telegram && window.Telegram.WebApp;
        if (tg && typeof tg.shareToStory === "function") {
          storyBtn.addEventListener("click", function() {
            hapticFeedback("impact");
            var cardUrl = API_BASE + "/api/story-card/" + encodeURIComponent(data.link_token);
            tg.shareToStory(cardUrl, {
              text: "Send me an anonymous message! \u2709\uFE0F\n" + fullLink,
              widget_link: {
                url: fullLink
              }
            });
          });
        } else {
          storyBtn.style.display = "none";
        }

      }).catch(function(err) {
        loadingEl.style.display = "none";
        document.getElementById("auth-error").style.display = "block";
        document.getElementById("auth-error-hint").textContent = "Error: " + err.message;
        showDebug();
      });
    }

    boot();
  })();
  </script>
</body>
</html>
