<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard — Incognitus</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=16">
  <style>
    /* ===== Reset ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
      -webkit-touch-callout: none !important;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== 8pt Spacing Tokens ===== */
    :root {
      --sp-2: 2px;
      --sp-4: 4px;
      --sp-8: 8px;
      --sp-12: 12px;
      --sp-16: 16px;
      --sp-20: 20px;
      --sp-24: 24px;
      --sp-32: 32px;
      --sp-40: 40px;
      --sp-48: 48px;

      /* Typography */
      --fs-caption: 11px;
      --fs-footnote: 12px;
      --fs-subhead: 13px;
      --fs-body: 15px;
      --fs-title3: 17px;
      --fs-title2: 20px;
      --fs-title1: 24px;

      /* Colors — dark */
      --bg-primary: #0f0c29;
      --bg-card: rgba(255,255,255,0.07);
      --bg-card-hover: rgba(255,255,255,0.11);
      --border-card: rgba(255,255,255,0.10);
      --text-primary: #f0f0f5;
      --text-secondary: rgba(255,255,255,0.50);
      --text-tertiary: rgba(255,255,255,0.30);
      --accent: #8b5cf6;
      --accent-soft: rgba(139,92,246,0.15);
      --accent-glow: rgba(139,92,246,0.30);
      --success: #34d399;
      --success-soft: rgba(52,211,153,0.12);
      --separator: rgba(255,255,255,0.06);

      /* Radius */
      --r-sm: 10px;
      --r-md: 14px;
      --r-lg: 20px;
      --r-full: 999px;
    }

    /* ===== Light theme ===== */
    .theme-light {
      --bg-primary: #f2f2f7;
      --bg-card: rgba(255,255,255,0.72);
      --bg-card-hover: rgba(255,255,255,0.90);
      --border-card: rgba(0,0,0,0.04);
      --text-primary: #1c1c1e;
      --text-secondary: rgba(0,0,0,0.45);
      --text-tertiary: rgba(0,0,0,0.22);
      --accent: #7c3aed;
      --accent-soft: rgba(124,58,237,0.10);
      --accent-glow: rgba(124,58,237,0.18);
      --success: #059669;
      --success-soft: rgba(5,150,105,0.08);
      --separator: rgba(0,0,0,0.06);
    }

    /* ===== Body ===== */
    body {
      background: linear-gradient(145deg, #0f0c29, #302b63, #24243e) !important;
      min-height: 100vh;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }
    body.theme-light {
      background: linear-gradient(145deg, #e8eaf6, #f3e5f5, #e0f2f1) !important;
    }

    .dashboard {
      max-width: 480px;
      margin: 0 auto;
      padding: var(--sp-8) var(--sp-20) 100px;
      position: relative;
    }

    /* ===== Floating gradient blobs ===== */
    .bg-blob {
      position: fixed;
      border-radius: 50%;
      filter: blur(90px);
      opacity: 0.25;
      pointer-events: none;
      z-index: 0;
      animation: blobFloat 8s ease-in-out infinite alternate;
    }
    .bg-blob-1 { width: 220px; height: 220px; top: -50px; left: -50px; animation-delay: 0s; }
    .bg-blob-2 { width: 200px; height: 200px; bottom: 40px; right: -60px; animation-delay: -3s; }
    .bg-blob-3 { width: 160px; height: 160px; top: 45%; left: 50%; transform: translate(-50%, -50%); animation-delay: -5s; }
    body.theme-light .bg-blob { opacity: 0.35; }

    @keyframes blobFloat {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(15px, -20px) scale(1.1); }
    }
    .bg-blob-3 { animation-name: blobFloat3; }
    @keyframes blobFloat3 {
      0% { transform: translate(-50%, -50%) scale(1); }
      100% { transform: translate(-40%, -55%) scale(1.15); }
    }

    /* ===== Animations ===== */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popBounce {
      0% { opacity: 0; transform: scale(0.5); }
      70% { transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes textReveal {
      from { opacity: 0; transform: translateY(8px); filter: blur(4px); }
      to { opacity: 1; transform: translateY(0); filter: blur(0); }
    }
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.92); }
      to { opacity: 1; transform: scale(1); }
    }
    .anim-in {
      opacity: 0;
      animation: fadeUp 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
    }

    /* ===== Profile Header ===== */
    .profile-header {
      text-align: center;
      margin-bottom: var(--sp-24);
      opacity: 0;
      animation: fadeUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.05s forwards;
    }
    .avatar-frame-wrapper {
      position: relative;
      width: 130px;
      height: 130px;
      margin: 0 auto var(--sp-12);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .avatar-frame-wrapper:active { opacity: 0.85; }
    .profile-avatar {
      width: 105px;
      height: 105px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--tg-theme-button-color), var(--tg-theme-link-color));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      box-shadow: 0 8px 28px rgba(64, 167, 227, 0.3);
      opacity: 0;
      animation: popBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.15s forwards;
    }
    .profile-avatar span {
      font-size: 52px;
      line-height: 1;
    }
    .avatar-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 130px;
      height: 130px;
      pointer-events: none;
      z-index: 1;
    }
    .profile-nickname {
      font-size: var(--fs-title2);
      font-weight: 800;
      margin-bottom: var(--sp-2);
      opacity: 0;
      animation: textReveal 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.35s forwards;
    }
    .profile-level {
      font-size: var(--fs-subhead);
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: var(--sp-4);
      margin-bottom: var(--sp-4);
      opacity: 0;
      animation: textReveal 0.55s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .profile-level:active { opacity: 0.7; }

    .level-progress-wrapper {
      width: 120px;
      height: 4px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 2px;
      margin: 0 auto var(--sp-8);
      overflow: hidden;
      opacity: 0;
      animation: textReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.45s forwards;
    }
    body.theme-light .level-progress-wrapper { background: rgba(0, 0, 0, 0.08); }
    .level-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #6d28d9);
      border-radius: 2px;
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .level-progress-bar::after {
      content: '';
      position: absolute;
      top: 0; left: -50%;
      width: 50%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
      animation: barShimmer 2s ease-in-out infinite;
    }
    @keyframes barShimmer {
      0% { left: -50%; }
      100% { left: 150%; }
    }
    .level-progress-bar.maxed {
      background: linear-gradient(90deg, #f5af19, #f12711, #f5af19);
      background-size: 200% 100%;
      animation: barGlow 2s ease infinite;
    }
    .level-progress-bar.maxed::after { display: none; }
    @keyframes barGlow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .profile-member-since {
      font-size: var(--fs-subhead);
      color: var(--text-secondary);
      opacity: 0;
      animation: textReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .profile-member-since:active { opacity: 0.7; }

    /* ===== Hint overlay (root-level popover) ===== */
    .hint-overlay {
      position: fixed;
      inset: 0;
      z-index: 9000;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }
    body.theme-light .hint-overlay {
      background: rgba(255, 255, 255, 0.35);
    }
    .hint-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .hint-bubble {
      position: fixed;
      z-index: 9001;
      background: var(--bg-card);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border-card);
      color: var(--text-primary);
      font-size: var(--fs-subhead);
      font-weight: 500;
      padding: var(--sp-12) var(--sp-16);
      border-radius: var(--r-md);
      max-width: 260px;
      text-align: center;
      line-height: 1.5;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
      opacity: 0;
      transform: scale(0.92);
      transition: opacity 0.12s ease, transform 0.12s ease;
      pointer-events: none;
    }
    body.theme-light .hint-bubble {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }
    .hint-bubble.visible {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    /* ===== Section Label ===== */
    .section-label {
      font-size: var(--fs-caption);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-secondary);
      padding: var(--sp-24) var(--sp-4) var(--sp-8);
    }

    /* ===== Card Group ===== */
    .card-group {
      background: var(--bg-card);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border-card);
      border-radius: var(--r-lg);
      overflow: hidden;
    }

    /* ===== Cell Row ===== */
    .cell {
      display: flex;
      align-items: center;
      gap: var(--sp-12);
      padding: var(--sp-12) var(--sp-16);
    }
    .cell + .cell { border-top: 1px solid var(--separator); }
    .cell-icon {
      width: 32px; height: 32px;
      border-radius: var(--r-sm);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .cell-icon svg { width: 18px; height: 18px; }
    .cell-icon.purple { background: var(--accent-soft); color: var(--accent); }
    .cell-icon.blue { background: rgba(59,130,246,0.12); color: #3b82f6; }
    .cell-icon.green { background: var(--success-soft); color: var(--success); }
    .cell-icon.orange { background: rgba(249,115,22,0.12); color: #f97316; }
    .cell-icon.red { background: rgba(239,68,68,0.10); color: #ef4444; }
    .cell-icon.pink { background: rgba(236,72,153,0.10); color: #ec4899; }
    .cell-icon.teal { background: rgba(20,184,166,0.10); color: #14b8a6; }
    .cell-icon.gray { background: rgba(107,114,128,0.10); color: #6b7280; }
    .theme-light .cell-icon.blue { background: rgba(59,130,246,0.08); }
    .theme-light .cell-icon.green { background: rgba(5,150,105,0.08); }
    .theme-light .cell-icon.orange { background: rgba(249,115,22,0.08); }
    .theme-light .cell-icon.red { background: rgba(239,68,68,0.06); }
    .theme-light .cell-icon.pink { background: rgba(236,72,153,0.06); }
    .theme-light .cell-icon.teal { background: rgba(20,184,166,0.06); }
    .theme-light .cell-icon.gray { background: rgba(107,114,128,0.06); }
    .cell-body { flex: 1; min-width: 0; }
    .cell-label {
      font-size: var(--fs-body);
      font-weight: 500;
    }
    .cell-value {
      font-size: var(--fs-body);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      opacity: 0;
      filter: blur(6px);
      transition: opacity 0.4s ease, filter 0.4s ease;
      flex-shrink: 0;
    }
    .cell-value.revealed {
      opacity: 1;
      filter: blur(0);
    }
    .cell-detail {
      font-size: var(--fs-subhead);
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cell-action { flex-shrink: 0; }

    /* ===== CTA Card ===== */
    .cta-card {
      background: linear-gradient(135deg, var(--accent), #6d28d9);
      border-radius: var(--r-lg);
      padding: var(--sp-20) var(--sp-16);
      position: relative;
      overflow: hidden;
    }
    .cta-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.15), transparent 60%);
      pointer-events: none;
    }
    .cta-top {
      display: flex;
      align-items: center;
      gap: var(--sp-12);
      margin-bottom: var(--sp-12);
    }
    .cta-icon {
      width: 36px; height: 36px;
      border-radius: var(--r-sm);
      background: rgba(255,255,255,0.18);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .cta-icon svg { width: 18px; height: 18px; color: #fff; }
    .cta-label {
      font-size: var(--fs-footnote);
      font-weight: 600;
      color: rgba(255,255,255,0.70);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cta-link-text {
      font-size: var(--fs-subhead);
      font-weight: 600;
      color: rgba(255,255,255,0.90);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: var(--sp-12);
      position: relative;
      z-index: 1;
    }
    .cta-copy-btn {
      display: inline-flex;
      align-items: center;
      gap: var(--sp-4);
      background: rgba(255,255,255,0.20);
      border: none;
      border-radius: var(--r-full);
      padding: var(--sp-8) var(--sp-16);
      font-size: var(--fs-subhead);
      font-weight: 600;
      font-family: inherit;
      color: #fff;
      cursor: pointer;
      transition: transform 0.12s, background 0.15s;
      position: relative;
      z-index: 1;
    }
    .cta-copy-btn:active { transform: scale(0.94); }
    .cta-copy-btn svg { width: 14px; height: 14px; }
    .cta-copy-btn.copied {
      background: rgba(52,211,153,0.5);
    }

    /* ===== Sticky bottom ===== */
    .sticky-bottom {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: var(--sp-12) var(--sp-20);
      padding-bottom: max(var(--sp-12), env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(15,12,41,0.95) 60%, transparent);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 100;
      display: none;
    }
    .theme-light .sticky-bottom {
      background: linear-gradient(to top, rgba(242,242,247,0.95) 60%, transparent);
    }
    .sticky-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--sp-8);
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: var(--sp-16);
      border: none;
      border-radius: var(--r-md);
      background: linear-gradient(135deg, var(--accent), #6d28d9);
      color: #fff;
      font-size: var(--fs-body);
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: transform 0.12s, opacity 0.12s;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .sticky-btn:active { transform: scale(0.97); }
    .sticky-btn svg { width: 18px; height: 18px; }

    .profile-save-btn {
      display: block;
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 0;
      border: none;
      border-radius: var(--r-md);
      background: linear-gradient(135deg, var(--accent), #6d28d9);
      color: #fff;
      font-size: var(--fs-body);
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 4px 20px var(--accent-glow);
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.3s ease, padding 0.3s ease, margin-top 0.3s ease, opacity 0.25s ease, transform 0.12s;
    }
    .profile-save-btn.visible {
      max-height: 60px;
      padding: var(--sp-12);
      margin-top: var(--sp-8);
      opacity: 1;
    }
    .profile-save-btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .profile-save-btn:active { transform: scale(0.97); }

    .profile-info-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--hint);
      color: var(--bg);
      font-size: 11px;
      font-weight: 700;
      font-family: inherit;
      border: none;
      cursor: pointer;
      margin-left: 6px;
      opacity: 0.45;
      transition: opacity 0.2s;
      vertical-align: middle;
      flex-shrink: 0;
    }
    .profile-info-btn:active { opacity: 0.7; }

    .profile-hint {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.25s ease, opacity 0.2s ease, padding 0.25s ease;
      padding: 0 var(--sp-16);
      font-size: var(--fs-detail);
      color: var(--hint);
      line-height: 1.45;
    }
    .profile-hint.open {
      max-height: 120px;
      opacity: 1;
      padding: var(--sp-8) var(--sp-16) var(--sp-12);
    }

    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card);
      color: var(--text);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: var(--fs-detail);
      font-weight: 600;
      box-shadow: 0 4px 24px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 9999;
      white-space: nowrap;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== Skeleton ===== */
    .skeleton-profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: var(--sp-24);
    }
    .skeleton-avatar-sm { width: 130px; height: 130px; border-radius: 50%; margin-bottom: var(--sp-12); }
    .skeleton-name { width: 120px; height: 22px; margin-bottom: var(--sp-4); }
    .skeleton-sub { width: 160px; height: 14px; }
    .skeleton-card-group {
      height: 200px;
      border-radius: var(--r-lg);
      margin-bottom: var(--sp-16);
    }
    .skeleton-cta {
      height: 100px;
      border-radius: var(--r-lg);
      margin-bottom: var(--sp-16);
    }
    .skeleton-info-group {
      height: 100px;
      border-radius: var(--r-lg);
    }

    /* ===== Auth error ===== */
    .empty-state { text-align: center; padding: var(--sp-48) var(--sp-20); }
    .empty-icon { margin-bottom: var(--sp-16); }
    .empty-icon svg { width: 48px; height: 48px; color: var(--text-secondary); }
    .empty-title { font-size: var(--fs-title3); font-weight: 700; margin-bottom: var(--sp-8); }
    .empty-hint { font-size: var(--fs-subhead); color: var(--text-secondary); line-height: 1.45; }

    /* Pause anim-in until dashboard is revealed */
    #dashboard .anim-in { animation-play-state: paused; }
    #dashboard.ready .anim-in { animation-play-state: running; }

    /* ===== About collapse ===== */
    .cell-chevron { flex-shrink: 0; display: flex; align-items: center; }
    [dir="rtl"] #about-chevron svg,
    [dir="rtl"] .cell-chevron svg[style*="polyline"] { /* handled inline */ }

    /* ===== Toggle Switch ===== */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 26px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--text-tertiary);
      border-radius: 26px;
      transition: background 0.25s ease;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      left: 2px;
      bottom: 2px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.25s ease;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: var(--accent);
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(18px);
    }

    /* ===== RTL ===== */
    [dir="rtl"] .cell { direction: rtl; }
    [dir="rtl"] .cta-top { direction: rtl; }
    [dir="rtl"] .cell-chevron svg[style*="polyline"] { transform: scaleX(-1); }
    [dir="rtl"] .toggle-slider::before { left: auto; right: 2px; }
    [dir="rtl"] .toggle-switch input:checked + .toggle-slider::before { transform: translateX(-18px); }
    [dir="rtl"] #profile-sub-toggles .cell-icon { margin-left: 0 !important; margin-right: 16px; }
  </style>
</head>
<body class="i18n-loading">
  <div class="container" id="app">
    <!-- Loading skeleton -->
    <div id="loading" class="page-content">
      <div class="skeleton-profile">
        <div class="skeleton skeleton-avatar-sm"></div>
        <div class="skeleton skeleton-name"></div>
        <div class="skeleton skeleton-sub"></div>
      </div>
      <div class="skeleton skeleton-card-group"></div>
      <div class="skeleton skeleton-cta"></div>
      <div class="skeleton skeleton-info-group"></div>
    </div>

    <!-- Background blobs (colored dynamically by JS) -->
    <div class="bg-blob bg-blob-1" id="blob1"></div>
    <div class="bg-blob bg-blob-2" id="blob2"></div>
    <div class="bg-blob bg-blob-3" id="blob3"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard" style="display:none">
      <div class="profile-header">
        <div class="avatar-frame-wrapper">
          <div class="profile-avatar" id="profile-avatar">
            <img id="avatar-img" style="display:none;width:100%;height:100%;border-radius:50%;object-fit:cover;pointer-events:none;-webkit-user-drag:none;-webkit-touch-callout:none;" alt="" draggable="false" />
            <span id="avatar-letter">?</span>
          </div>
          <img class="avatar-frame" id="avatar-frame-img" src="https://lazez.uz/addons/frame.webp" alt="" />
        </div>
        <div class="profile-nickname" id="profile-nickname"></div>
        <div class="profile-level" id="profile-level"></div>
        <div class="level-progress-wrapper">
          <div class="level-progress-bar" id="level-progress-bar"></div>
        </div>
        <div class="profile-member-since" id="profile-since"></div>
      </div>

      <!-- Stats grouped cell list -->
      <div class="section-label anim-in" style="animation-delay:0.2s" data-i18n="stats_label"></div>
      <div class="card-group anim-in" style="animation-delay:0.25s" id="stats-group">
        <div class="cell">
          <div class="cell-icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="8 12 12 16 16 12"/><line x1="12" y1="8" x2="12" y2="16"/></svg>
          </div>
          <div class="cell-body"><span class="cell-label" data-i18n="received"></span></div>
          <div class="cell-value" id="stat-received">0</div>
        </div>
        <div class="cell">
          <div class="cell-icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="16 12 12 8 8 12"/><line x1="12" y1="16" x2="12" y2="8"/></svg>
          </div>
          <div class="cell-body"><span class="cell-label" data-i18n="sent"></span></div>
          <div class="cell-value" id="stat-sent">0</div>
        </div>
        <div class="cell">
          <div class="cell-icon red">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
          </div>
          <div class="cell-body"><span class="cell-label" data-i18n="blocked"></span></div>
          <div class="cell-value" id="stat-blocked">0</div>
        </div>
        <div class="cell">
          <div class="cell-icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          </div>
          <div class="cell-body"><span class="cell-label" data-i18n="revokes"></span></div>
          <div class="cell-value" id="stat-revokes">0</div>
        </div>
      </div>

      <!-- Link CTA card -->
      <div class="anim-in" style="animation-delay:0.35s;padding-top:var(--sp-16)">
        <div class="cta-card" id="cta-card">
          <div class="cta-top">
            <div class="cta-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            </div>
            <div class="cta-label" data-i18n="your_link"></div>
          </div>
          <div class="cta-link-text" id="cta-link-text"></div>
          <button class="cta-copy-btn" id="copy-link-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            <span data-i18n="copy"></span>
          </button>
        </div>
      </div>

      <!-- Profile toggles -->
      <div class="section-label anim-in" style="animation-delay:0.38s" data-i18n="profile_label"></div>
      <div class="card-group anim-in" style="animation-delay:0.40s" id="profile-group">
        <div class="cell">
          <div class="cell-icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div class="cell-body"><span class="cell-label" data-i18n="profile_public"></span><button class="profile-info-btn" id="profile-info-btn" type="button">?</button></div>
          <label class="toggle-switch"><input type="checkbox" id="toggle-profile-public"><span class="toggle-slider"></span></label>
        </div>
        <div class="profile-hint" id="profile-hint" data-i18n="profile_public_hint"></div>
        <div id="profile-sub-toggles" style="display:none">
          <div class="cell">
            <div class="cell-icon orange" style="margin-left:16px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div class="cell-body"><span class="cell-label" data-i18n="profile_show_last_seen"></span></div>
            <label class="toggle-switch"><input type="checkbox" id="toggle-profile-last-seen"><span class="toggle-slider"></span></label>
          </div>
          <div class="cell">
            <div class="cell-icon green" style="margin-left:16px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </div>
            <div class="cell-body"><span class="cell-label" data-i18n="profile_show_level"></span></div>
            <label class="toggle-switch"><input type="checkbox" id="toggle-profile-level"><span class="toggle-slider"></span></label>
          </div>
          <div class="cell">
            <div class="cell-icon blue" style="margin-left:16px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </div>
            <div class="cell-body"><span class="cell-label" data-i18n="profile_show_active_days"></span></div>
            <label class="toggle-switch"><input type="checkbox" id="toggle-profile-active-days"><span class="toggle-slider"></span></label>
          </div>
          <div class="cell">
            <div class="cell-icon teal" style="margin-left:16px">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            </div>
            <div class="cell-body"><span class="cell-label" data-i18n="profile_show_registered"></span></div>
            <label class="toggle-switch"><input type="checkbox" id="toggle-profile-registered"><span class="toggle-slider"></span></label>
          </div>
        </div>
      </div>
      <button class="profile-save-btn anim-in" style="animation-delay:0.42s" id="profile-save-btn" data-i18n="profile_save">Save</button>

      <!-- Info grouped cell list -->
      <div class="section-label anim-in" style="animation-delay:0.48s" data-i18n="info_label"></div>
      <div class="card-group anim-in" style="animation-delay:0.50s" id="info-group">
        <div class="cell">
          <div class="cell-icon teal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </div>
          <div class="cell-body">
            <div class="cell-label" data-i18n="member_since"></div>
            <div class="cell-detail" id="info-registered"></div>
          </div>
        </div>
        <div class="cell">
          <div class="cell-icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="cell-body">
            <div class="cell-label" data-i18n="days_active"></div>
            <div class="cell-detail" id="info-days"></div>
          </div>
        </div>
      </div>

      <!-- About section (collapsed by default) -->
      <div class="section-label anim-in" style="animation-delay:0.56s" data-i18n="about_label"></div>
      <div class="card-group anim-in" style="animation-delay:0.58s;cursor:pointer" id="about-group">
        <div class="cell">
          <div class="cell-icon gray">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          </div>
          <div class="cell-body"><span class="cell-label" data-i18n="about_label"></span></div>
          <div class="cell-chevron" id="about-chevron">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;color:var(--text-tertiary);transition:transform 0.25s ease"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
        </div>
        <div id="about-details" style="display:none">
          <div class="cell">
            <div class="cell-icon purple">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
            </div>
            <div class="cell-body"><span class="cell-label" data-i18n="about_version"></span></div>
            <div class="cell-value revealed" id="about-version"></div>
          </div>
          <div class="cell">
            <div class="cell-icon teal">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div class="cell-body"><span class="cell-label" data-i18n="about_updated"></span></div>
            <div class="cell-value revealed" id="about-updated"></div>
          </div>
          <div class="cell" id="about-channel-cell" style="cursor:pointer">
            <div class="cell-icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div class="cell-body">
              <span class="cell-label" data-i18n="about_channel"></span>
              <div class="cell-detail">@ClearSayMe</div>
            </div>
            <div class="cell-chevron">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;color:var(--text-tertiary)"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
          </div>
          <div class="cell" id="about-support-cell" style="cursor:pointer">
            <div class="cell-icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </div>
            <div class="cell-body">
              <span class="cell-label" data-i18n="about_support"></span>
              <div class="cell-detail">@eagerbot</div>
            </div>
            <div class="cell-chevron">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;color:var(--text-tertiary)"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Auth error -->
    <div id="auth-error" style="display:none">
      <div class="empty-state">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </div>
        <div class="empty-title" data-i18n="open_in_tg"></div>
        <div class="empty-hint" id="auth-error-hint" data-i18n="open_in_tg_hint"></div>
        <pre id="debug-info" style="font-size:11px;color:var(--text-secondary);margin-top:16px;text-align:left;word-break:break-all;white-space:pre-wrap"></pre>
      </div>
    </div>

    <!-- Root-level hint overlay -->
    <div class="hint-overlay" id="hint-overlay"></div>
    <div class="hint-bubble" id="hint-bubble"></div>
  </div>

  <!-- Sticky share story button -->
  <div class="sticky-bottom" id="sticky-story">
    <button class="sticky-btn" id="share-story-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
      <span data-i18n="share_story"></span>
    </button>
  </div>

  <script src="js/telegram.js?v=19"></script>
  <script src="js/api.js?v=19"></script>
  <script src="js/i18n.js?v=20"></script>
  <script>
  (function() {
    "use strict";
    initWebApp();

    // Route to help page if startapp=help
    (function checkStartApp() {
      var tg = window.Telegram && window.Telegram.WebApp;
      var startParam = "";
      if (tg && tg.initDataUnsafe) startParam = tg.initDataUnsafe.start_param || "";
      if (!startParam) {
        var params = new URLSearchParams(window.location.search);
        startParam = params.get("tgWebAppStartParam") || "";
      }
      if (startParam === "help") {
        window.location.replace("help.html");
        return;
      }
    })();

    // Disable text selection and context menu
    document.addEventListener("selectstart", function(e) { e.preventDefault(); });
    document.addEventListener("contextmenu", function(e) { e.preventDefault(); });
    document.addEventListener("copy", function(e) { e.preventDefault(); });

    // Detect light/dark theme from Telegram
    (function detectTheme() {
      var tg = window.Telegram && window.Telegram.WebApp;
      var bg = (tg && tg.themeParams && tg.themeParams.bg_color) || "";
      if (bg) {
        var hex = bg.replace("#", "");
        var r = parseInt(hex.substring(0, 2), 16) || 0;
        var g = parseInt(hex.substring(2, 4), 16) || 0;
        var b = parseInt(hex.substring(4, 6), 16) || 0;
        var brightness = (r * 299 + g * 587 + b * 114) / 1000;
        if (brightness > 128) document.body.classList.add("theme-light");
      }
    })();

    function tryGetInitData() {
      var d = getInitData();
      if (d) return d;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData)
        return window.Telegram.WebApp.initData;
      return "";
    }

    function boot() {
      var data = tryGetInitData();
      if (data) { startApp(data); return; }
      setTimeout(function() {
        data = tryGetInitData();
        if (data) { startApp(data); return; }
        setTimeout(function() {
          data = tryGetInitData();
          if (data) { startApp(data); return; }
          i18n.detect().then(function() {
            document.getElementById("loading").style.display = "none";
            document.getElementById("auth-error").style.display = "block";
            showDebug();
          });
        }, 1000);
      }, 500);
    }

    // Use global i18n module (js/i18n.js)
    var t = i18n.t;

    function showDebug() {
      var d = document.getElementById("debug-info");
      var tg = window.Telegram && window.Telegram.WebApp;
      var lines = ["TG: " + (tg ? "yes" : "no")];
      if (tg) {
        lines.push("platform: " + tg.platform);
        lines.push("initData len: " + (tg.initData || "").length);
      }
      d.textContent = lines.join("\n");
    }

    // Smart relative time helper
    function relativeTime(isoStr) {
      if (!isoStr) return "—";
      try {
        var d = new Date(isoStr);
        var diff = Date.now() - d.getTime();
        var min = Math.floor(diff / 60000);
        var hrs = Math.floor(diff / 3600000);
        var days = Math.floor(diff / 86400000);
        if (min < 1) return t("just_now");
        if (min < 60) return t("minutes_ago").replace("{n}", min);
        if (hrs < 24) return t("hours_ago").replace("{n}", hrs);
        return t("days_ago").replace("{n}", days);
      } catch(e) { return "—"; }
    }

    // Animated count-up with easing + blur reveal
    function animateValue(el, target, duration, delay) {
      delay = delay || 0;
      setTimeout(function() {
        el.classList.add("revealed");
        if (target === 0) { el.textContent = "0"; return; }
        var startTime = null;
        duration = duration || 1000;
        function step(ts) {
          if (!startTime) startTime = ts;
          var p = Math.min((ts - startTime) / duration, 1);
          var eased = 1 - Math.pow(1 - p, 4);
          el.textContent = Math.round(target * eased);
          if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }, delay);
    }

    function startApp(initData) {
      var loadingEl   = document.getElementById("loading");
      var dashboardEl = document.getElementById("dashboard");

      fetchDashboard(initData).then(function(data) {
        // Load language from API, apply [data-i18n] elements
        return i18n.load(data.lang || "en").then(function() {
          i18n.apply();
          return data;
        });
      }).then(function(data) {

        loadingEl.style.display = "none";
        dashboardEl.style.display = "block";
        // Trigger anim-in animations fresh from this frame
        requestAnimationFrame(function() { dashboardEl.classList.add("ready"); });

        // Profile header
        var nick = data.nickname || "?";
        var hash = 0;
        for (var ci = 0; ci < nick.length; ci++) hash = (hash * 31 + nick.charCodeAt(ci)) | 0;
        hash = Math.abs(hash);
        // Secondary hash for gradient (Knuth multiplicative) so gradient varies independently from emoji
        var gradHash = Math.abs(Math.imul(hash, 2654435761) | 0);
        // Avatar: use pre-rendered image if available, otherwise emoji image fallback
        var gradients = [
          ["#FF6B6B","#EE5A24"],["#A29BFE","#6C5CE7"],["#55E6C1","#1ABC9C"],
          ["#FECA57","#FF9F43"],["#FF9FF3","#F368E0"],["#48DBFB","#0ABDE3"],
          ["#FF6348","#FF4757"],["#7BED9F","#2ED573"],["#70A1FF","#1E90FF"],
          ["#FFA502","#E17055"],["#DCDDE1","#A4B0BD"],["#FD79A8","#E84393"],
          ["#BADC58","#6AB04C"],["#F8C291","#E55039"],["#82CCDD","#3C6382"],
          ["#B8E994","#78E08F"],["#FDA7DF","#D980FA"],["#F7D794","#F5CD79"]
        ];
        var grad = gradients[gradHash % gradients.length];
        var avatarEl = document.querySelector(".profile-avatar");

        if (data.avatar_url) {
          var avatarImg = document.getElementById("avatar-img");
          avatarImg.src = API_BASE + data.avatar_url;
          avatarImg.style.display = "block";
          avatarImg.style.borderRadius = "0";
          document.getElementById("avatar-letter").style.display = "none";
          avatarEl.style.background = "transparent";
          avatarEl.style.boxShadow = "none";
          avatarEl.style.width = "130px";
          avatarEl.style.height = "130px";
          avatarEl.style.borderRadius = "0";
          // Hide CSS frame — the pre-rendered avatar already includes the frame
          document.querySelector(".avatar-frame").style.display = "none";
        } else if (data.emoji_url) {
          // Show emoji PNG on gradient circle
          var emojiImg = document.createElement("img");
          emojiImg.src = data.emoji_url;
          emojiImg.alt = "";
          emojiImg.draggable = false;
          emojiImg.style.cssText = "width:60px;height:60px;pointer-events:none;-webkit-user-drag:none;-webkit-touch-callout:none;";
          document.getElementById("avatar-letter").style.display = "none";
          avatarEl.appendChild(emojiImg);
          avatarEl.style.background = "linear-gradient(135deg, " + grad[0] + ", " + grad[1] + ")";
          avatarEl.style.boxShadow = "0 6px 24px " + grad[0] + "40";
        } else {
          document.getElementById("avatar-letter").textContent = nick.charAt(0).toUpperCase();
          avatarEl.style.background = "linear-gradient(135deg, " + grad[0] + ", " + grad[1] + ")";
          avatarEl.style.boxShadow = "0 6px 24px " + grad[0] + "40";
        }

        // Color the background blobs
        document.getElementById("blob1").style.background = grad[0];
        document.getElementById("blob2").style.background = grad[1];
        document.getElementById("blob3").style.background = grad[0];
        document.getElementById("profile-nickname").textContent = nick;

        // Dynamic frame URL
        if (data.frame_url) {
          document.getElementById("avatar-frame-img").src = data.frame_url;
        }

        // ---- Hint popover system (root overlay) ----
        var hintOverlay = document.getElementById("hint-overlay");
        var hintBubble = document.getElementById("hint-bubble");

        function dismissHint() {
          hintBubble.classList.remove("visible");
          hintOverlay.classList.remove("visible");
        }

        function showHint(anchorEl, text) {
          // Reset previous
          hintBubble.classList.remove("visible");
          hintOverlay.classList.remove("visible");

          hintBubble.textContent = text;
          // Make measurable but invisible (no transition class yet)
          hintBubble.style.cssText = "position:fixed;z-index:9001;opacity:0;transform:scale(0.92);left:0;top:0;";
          // Force reflow for measurement
          void hintBubble.offsetWidth;

          // Position relative to anchor
          var rect = anchorEl.getBoundingClientRect();
          var bw = hintBubble.offsetWidth;
          var bh = hintBubble.offsetHeight;
          var vw = window.innerWidth;
          var cx = rect.left + rect.width / 2;
          var left = Math.max(12, Math.min(cx - bw / 2, vw - bw - 12));
          // Prefer above; if no room, go below
          var gap = 10;
          var top = rect.top - bh - gap;
          if (top < 12) top = rect.bottom + gap;

          hintBubble.style.cssText = "";
          hintBubble.style.left = left + "px";
          hintBubble.style.top = top + "px";
          // Next frame: animate in
          requestAnimationFrame(function() {
            hintOverlay.classList.add("visible");
            hintBubble.classList.add("visible");
          });

          hapticFeedback("impact");
        }

        hintOverlay.addEventListener("click", dismissHint);

        // Avatar tap hint
        document.querySelector(".avatar-frame-wrapper").addEventListener("click", function(e) {
          e.stopPropagation();
          showHint(this, t("avatar_hint"));
        });

        // Level badge + progress bar
        if (data.level_title) {
          document.getElementById("profile-level").textContent = data.level_title;
          document.getElementById("profile-level").addEventListener("click", function(e) {
            e.stopPropagation();
            showHint(this, t("level_hint"));
          });
        }
        var progressPct = typeof data.level_progress === "number" ? data.level_progress : 0;
        var progressBar = document.getElementById("level-progress-bar");
        if (progressPct >= 0.95) {
          progressBar.classList.add("maxed");
        }
        setTimeout(function() {
          progressBar.style.width = (progressPct * 100) + "%";
        }, 600);

        // Last seen under profile pic (tappable for full date)
        var lastSeenText = t("last_seen") + " " + relativeTime(data.last_activity);
        document.getElementById("profile-since").textContent = lastSeenText;
        if (data.last_activity) {
          var sinceHintText = "";
          try {
            var ld = new Date(data.last_activity);
            var loc = i18n.lang === "fa" ? "fa-IR" : i18n.lang === "ar" ? "ar-SA" : i18n.lang === "ru" ? "ru-RU" : "en-US";
            var fullDate = ld.toLocaleString(loc, { year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
            sinceHintText = t("last_seen_hint").replace("{date}", fullDate);
          } catch(e) {
            sinceHintText = data.last_activity;
          }
          document.getElementById("profile-since").addEventListener("click", function(e) {
            e.stopPropagation();
            showHint(this, sinceHintText);
          });
        }

        // Animate stat counters with staggered blur reveal
        animateValue(document.getElementById("stat-received"), data.messages_received || 0, 1000, 300);
        animateValue(document.getElementById("stat-sent"), data.messages_sent || 0, 900, 450);
        animateValue(document.getElementById("stat-blocked"), data.blocked_count || 0, 800, 600);
        animateValue(document.getElementById("stat-revokes"), data.revoke_count || 0, 700, 750);

        // Link CTA card
        var botUser = data.bot_username || "ClearSayBot";
        var fullLink = "https://t.me/" + botUser + "?start=" + (data.link_token || "");
        document.getElementById("cta-link-text").textContent = fullLink;

        // Copy button
        var copyBtn = document.getElementById("copy-link-btn");
        copyBtn.addEventListener("click", function() {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(fullLink).then(function() {
              onCopied();
            }).catch(function() {
              fallbackCopy(fullLink);
            });
          } else {
            fallbackCopy(fullLink);
          }
        });

        function fallbackCopy(text) {
          var ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand("copy"); onCopied(); } catch(e) {}
          document.body.removeChild(ta);
        }

        function onCopied() {
          hapticFeedback("success");
          var spans = copyBtn.querySelectorAll("span");
          if (spans.length) spans[0].textContent = t("copied");
          copyBtn.classList.add("copied");
          setTimeout(function() {
            if (spans.length) spans[0].textContent = t("copy");
            copyBtn.classList.remove("copied");
          }, 2000);
        }

        // Info cards — member since with date + relative time in parens
        var regDisplay = "—";
        if (data.registered_at) {
          try {
            var rd = new Date(data.registered_at);
            var locale = i18n.lang === "fa" ? "fa-IR" : i18n.lang === "ar" ? "ar-SA" : i18n.lang === "ru" ? "ru-RU" : "en-US";
            var dateStr = rd.toLocaleDateString(locale, { year: "numeric", month: "short", day: "numeric" });
            regDisplay = dateStr + " (" + relativeTime(data.registered_at) + ")";
          } catch(e) {}
        }
        document.getElementById("info-registered").textContent = regDisplay;

        // Days active — computed from registration
        var daysActive = 0;
        if (data.registered_at) {
          try { daysActive = Math.floor((Date.now() - new Date(data.registered_at).getTime()) / 86400000); } catch(e) {}
        }
        document.getElementById("info-days").textContent = daysActive;

        // ---- Share to Story ----
        var storyBtn = document.getElementById("share-story-btn");
        var stickyStory = document.getElementById("sticky-story");
        var tg = window.Telegram && window.Telegram.WebApp;
        if (tg && typeof tg.shareToStory === "function") {
          stickyStory.style.display = "block";
          storyBtn.addEventListener("click", function() {
            hapticFeedback("impact");
            var cardUrl = API_BASE + "/api/story-card/" + encodeURIComponent(data.link_token);
            tg.shareToStory(cardUrl, {
              text: "Send me an anonymous message! \u2709\uFE0F\n" + fullLink
            });
          });
        }

        // ---- Profile toggles ----
        var profilePublicToggle = document.getElementById("toggle-profile-public");
        var profileSubToggles = document.getElementById("profile-sub-toggles");
        var profileLastSeen = document.getElementById("toggle-profile-last-seen");
        var profileLevel = document.getElementById("toggle-profile-level");
        var profileActiveDays = document.getElementById("toggle-profile-active-days");
        var profileRegistered = document.getElementById("toggle-profile-registered");

        // Set initial state from API data
        profilePublicToggle.checked = !!data.profile_public;
        profileLastSeen.checked = !!data.profile_show_last_seen;
        profileLevel.checked = data.profile_show_level !== false;
        profileActiveDays.checked = data.profile_show_active_days !== false;
        profileRegistered.checked = data.profile_show_registered !== false;
        profileSubToggles.style.display = profilePublicToggle.checked ? "block" : "none";

        // Track saved state for smart dirty detection
        var profileSaved = {
          profile_public: profilePublicToggle.checked,
          profile_show_last_seen: profileLastSeen.checked,
          profile_show_level: profileLevel.checked,
          profile_show_active_days: profileActiveDays.checked,
          profile_show_registered: profileRegistered.checked
        };

        var profileSaveBtn = document.getElementById("profile-save-btn");

        function showToast(msg) {
          var el = document.getElementById("toast");
          el.textContent = msg;
          el.classList.add("show");
          setTimeout(function() { el.classList.remove("show"); }, 2000);
        }

        function getProfileState() {
          return {
            profile_public: profilePublicToggle.checked,
            profile_show_last_seen: profileLastSeen.checked,
            profile_show_level: profileLevel.checked,
            profile_show_active_days: profileActiveDays.checked,
            profile_show_registered: profileRegistered.checked
          };
        }

        function checkProfileDirty() {
          var cur = getProfileState();
          var dirty = false;
          for (var k in profileSaved) {
            if (cur[k] !== profileSaved[k]) { dirty = true; break; }
          }
          if (dirty) {
            profileSaveBtn.classList.add("visible");
          } else {
            profileSaveBtn.classList.remove("visible");
          }
        }

        var profileSaving = false;
        profileSaveBtn.addEventListener("click", function() {
          if (profileSaving) return;
          profileSaving = true;
          var s = getProfileState();
          profileSaveBtn.classList.add("loading");
          updateProfileSettings(initData, s).then(function() {
            profileSaved = s;
            profileSaveBtn.classList.remove("loading");
            profileSaveBtn.classList.remove("visible");
            hapticFeedback("success");
            showToast("\u2705 " + t("profile_saved"));
            profileSaving = false;
          }).catch(function(e) {
            console.error("Profile settings error:", e);
            profileSaveBtn.classList.remove("loading");
            profileSaveBtn.classList.add("visible");
            profileSaving = false;
          });
        });

        // Inline hint toggle for public profile info
        var profileHint = document.getElementById("profile-hint");
        document.getElementById("profile-info-btn").addEventListener("click", function(e) {
          e.stopPropagation();
          hapticFeedback("impact");
          profileHint.classList.toggle("open");
        });

        profilePublicToggle.addEventListener("change", function() {
          hapticFeedback("impact");
          profileSubToggles.style.display = this.checked ? "block" : "none";
          checkProfileDirty();
        });
        profileLastSeen.addEventListener("change", function() {
          hapticFeedback("impact");
          checkProfileDirty();
        });
        profileLevel.addEventListener("change", function() {
          hapticFeedback("impact");
          checkProfileDirty();
        });
        profileActiveDays.addEventListener("change", function() {
          hapticFeedback("impact");
          checkProfileDirty();
        });
        profileRegistered.addEventListener("change", function() {
          hapticFeedback("impact");
          checkProfileDirty();
        });

        // ---- About section ----
        document.getElementById("about-version").textContent = "1.0.0";
        document.getElementById("about-updated").textContent = "2026-02-18";

        var aboutGroup = document.getElementById("about-group");
        var aboutDetails = document.getElementById("about-details");
        var aboutChevron = document.getElementById("about-chevron").querySelector("svg");
        var aboutOpen = false;

        // Toggle expand/collapse on the header cell click
        aboutGroup.querySelector(".cell").addEventListener("click", function(e) {
          aboutOpen = !aboutOpen;
          aboutDetails.style.display = aboutOpen ? "block" : "none";
          aboutChevron.style.transform = aboutOpen ? "rotate(180deg)" : "rotate(0)";
          hapticFeedback("impact");
        });

        // Channel & support open Telegram links
        document.getElementById("about-channel-cell").addEventListener("click", function(e) {
          e.stopPropagation();
          var tgApp = window.Telegram && window.Telegram.WebApp;
          if (tgApp && tgApp.openTelegramLink) {
            tgApp.openTelegramLink("https://t.me/ClearSayMe");
          } else {
            window.open("https://t.me/ClearSayMe", "_blank");
          }
        });
        document.getElementById("about-support-cell").addEventListener("click", function(e) {
          e.stopPropagation();
          var tgApp = window.Telegram && window.Telegram.WebApp;
          if (tgApp && tgApp.openTelegramLink) {
            tgApp.openTelegramLink("https://t.me/eagerbot");
          } else {
            window.open("https://t.me/eagerbot", "_blank");
          }
        });

      }).catch(function(err) {
        // Ensure i18n is loaded before showing error UI
        var show = function() {
          loadingEl.style.display = "none";
          document.getElementById("auth-error").style.display = "block";
          document.getElementById("auth-error-hint").textContent = "Error: " + err.message;
          document.body.classList.remove("i18n-loading");
          showDebug();
        };
        if (i18n.lang !== "en" || document.body.classList.contains("i18n-loading")) {
          i18n.detect().then(show).catch(show);
        } else {
          show();
        }
      });
    }

    boot();
  })();
  </script>
  <div class="toast" id="toast"></div>
</body>
</html>
